// ==== base ====
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ==== part: Automation.prisma ====
// ===== Enums =====
enum AutomationTriggerEvent {
  PRODUCT_PUBLISHED
  PRODUCT_UPDATED
}

enum AutomationActionType {
  SEND_EMAIL
  POST_FACEBOOK
  POST_TIKTOK
  CREATE_TIKTOK_AD
}

enum ChannelConnectionChannel {
  EMAIL_PROVIDER
  META
  TIKTOK
}

enum ChannelConnectionStatus {
  CONNECTED
  EXPIRED
  REVOKED
  ERROR
}

enum AutomationEventType {
  PRODUCT_PUBLISHED
  PRODUCT_UPDATED
}

enum AutomationEntityType {
  PRODUCT
}

enum OutboxStatus {
  NEW
  PROCESSING
  DONE
  FAILED
}

enum JobRunStatus {
  QUEUED
  RUNNING
  SUCCEEDED
  FAILED
  CANCELLED
}

enum ActionRunStatus {
  PENDING
  SUCCEEDED
  FAILED
  SKIPPED
}

enum MessageChannel {
  EMAIL
  FACEBOOK
  TIKTOK
}

enum AudienceMemberStatus {
  SUBSCRIBED
  UNSUBSCRIBED
  BOUNCED
}

// ===== Models =====

model AutomationRule {
  id      String  @id @default(cuid())
  siteId  String
  name    String
  enabled Boolean @default(true)

  triggerEvent    AutomationTriggerEvent
  filterJson      Json?
  cooldownSeconds Int?

  createdByUserId String

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  site      Site @relation(fields: [siteId], references: [id], onDelete: Restrict)
  createdBy User @relation(fields: [createdByUserId], references: [id], onDelete: Restrict)

  actions AutomationAction[]
  jobRuns AutomationJobRun[]

  @@index([siteId, triggerEvent])
  @@index([siteId, enabled])
  @@map("automation_rules")
}

model AutomationAction {
  id     String @id @default(cuid())
  ruleId String

  type       AutomationActionType
  configJson Json
  sortOrder  Int                  @default(0)
  enabled    Boolean              @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  rule       AutomationRule        @relation(fields: [ruleId], references: [id], onDelete: Cascade)
  actionRuns AutomationActionRun[]

  @@index([ruleId, sortOrder])
  @@index([ruleId, enabled])
  @@map("automation_actions")
}

model ChannelConnection {
  id     String @id @default(cuid())
  siteId String

  channel   ChannelConnectionChannel
  provider  String
  accountId String?

  accessTokenEnc  String
  refreshTokenEnc String?
  tokenExpiresAt  DateTime?
  scopes          String?
  status          ChannelConnectionStatus @default(CONNECTED)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  site Site @relation(fields: [siteId], references: [id], onDelete: Restrict)

  @@index([siteId, channel])
  @@index([siteId, status])
  @@map("channel_connections")
}

model AutomationEventOutbox {
  id     String @id @default(cuid())
  siteId String

  eventType  AutomationEventType
  entityType AutomationEntityType
  entityId   String

  payloadJson Json
  status      OutboxStatus @default(NEW)
  attempts    Int          @default(0)
  nextRetryAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  site    Site               @relation(fields: [siteId], references: [id], onDelete: Restrict)
  jobRuns AutomationJobRun[]

  @@index([siteId, status, nextRetryAt])
  @@index([eventType, entityType, entityId])
  @@map("automation_event_outbox")
}

model AutomationJobRun {
  id            String @id @default(cuid())
  siteId        String
  ruleId        String
  eventOutboxId String

  status       JobRunStatus @default(QUEUED)
  startedAt    DateTime?
  finishedAt   DateTime?
  errorMessage String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  site        Site                  @relation(fields: [siteId], references: [id], onDelete: Restrict)
  rule        AutomationRule        @relation(fields: [ruleId], references: [id], onDelete: Restrict)
  eventOutbox AutomationEventOutbox @relation(fields: [eventOutboxId], references: [id], onDelete: Restrict)

  actionRuns AutomationActionRun[]

  @@index([siteId, status, createdAt])
  @@index([ruleId, createdAt])
  @@index([eventOutboxId])
  @@map("automation_job_runs")
}

model AutomationActionRun {
  id       String @id @default(cuid())
  jobRunId String
  actionId String

  channel ChannelConnectionChannel
  status  ActionRunStatus          @default(PENDING)

  requestPayloadJson  Json?
  responsePayloadJson Json?
  externalReferenceId String?

  attempts  Int     @default(0)
  lastError String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  jobRun AutomationJobRun @relation(fields: [jobRunId], references: [id], onDelete: Cascade)
  action AutomationAction @relation(fields: [actionId], references: [id], onDelete: Restrict)

  @@index([jobRunId, status])
  @@index([actionId])
  @@map("automation_action_runs")
}

model MessageTemplate {
  id     String @id @default(cuid())
  siteId String

  channel         MessageChannel
  name            String
  subject         String?
  body            String         @db.Text
  variablesSchema Json?

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  site Site @relation(fields: [siteId], references: [id], onDelete: Restrict)

  @@index([siteId, channel])
  @@map("message_templates")
}

model Audience {
  id     String @id @default(cuid())
  siteId String
  name   String

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  site    Site             @relation(fields: [siteId], references: [id], onDelete: Restrict)
  members AudienceMember[]

  @@index([siteId, name])
  @@map("audiences")
}

model AudienceMember {
  id         String @id @default(cuid())
  audienceId String

  customerId String?
  email      String
  status     AudienceMemberStatus @default(SUBSCRIBED)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  audience Audience  @relation(fields: [audienceId], references: [id], onDelete: Cascade)
  customer Customer? @relation(fields: [customerId], references: [id], onDelete: SetNull)

  @@index([audienceId, status])
  @@index([email])
  @@map("audience_members")
}

// ==== part: Customer.prisma ====
model Customer {
  id     String  @id @default(cuid())
  siteId String  @map("site_id")
  userId String? @map("user_id")

  name      String
  email     String?
  phone     String?
  avatarUrl String? @map("avatar_url")
  notes     String?
  tags      Json?
  isActive  Boolean @default(true) @map("is_active")

  lastOrderAt DateTime? @map("last_order_at")
  totalOrders Int       @default(0) @map("total_orders")
  totalSpent  Decimal   @default(0) @map("total_spent") @db.Decimal(18, 2)

  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")
  deletedAt DateTime? @map("deleted_at")

  site            Site             @relation(fields: [siteId], references: [id], onDelete: Restrict)
  user            User?            @relation(fields: [userId], references: [id], onDelete: SetNull)
  addresses       Address[]
  audienceMembers AudienceMember[]
  orders          Order[]

  @@unique([siteId, email], map: "uq_customers_site_email")
  @@index([siteId, phone], map: "idx_customers_site_phone")
  @@index([siteId, createdAt], map: "idx_customers_site_created_at")
  @@index([siteId, lastOrderAt], map: "idx_customers_site_last_order_at")
  @@map("customers")
}

enum AddressType {
  SHIPPING
  BILLING
  BOTH
}

model Address {
  id         String @id @default(cuid())
  siteId     String @map("site_id")
  customerId String @map("customer_id")

  type      AddressType
  isDefault Boolean     @default(false) @map("is_default")

  receiverName String  @map("receiver_name")
  phone        String
  email        String?
  line1        String
  line2        String?
  ward         String?
  district     String?
  city         String
  region       String?
  country      String  @default("VN")
  postalCode   String? @map("postal_code")
  companyName  String? @map("company_name")
  taxCode      String? @map("tax_code")

  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")
  deletedAt DateTime? @map("deleted_at")

  site     Site     @relation(fields: [siteId], references: [id], onDelete: Restrict)
  customer Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)

  @@index([siteId, customerId], map: "idx_addresses_site_customer")
  @@map("addresses")
}

// ==== part: Menu.prisma ====
enum MenuItemType {
  PAGE
  CUSTOM_URL
}

enum MenuSetKey {
  home
  dashboard
}

model MenuItem {
  id        String       @id @default(cuid())
  siteId    String       @map("site_id")
  parentId  String?      @map("parent_id")
  pageId    String?      @map("page_id")
  title     String?
  type      MenuItemType @default(PAGE)
  customUrl String?      @map("custom_url")
  sortOrder Int          @default(0) @map("sort_order")
  visible   Boolean      @default(true)
  setKey    MenuSetKey   @default(home) @map("set_key")
  createdAt DateTime     @default(now()) @map("created_at")
  updatedAt DateTime     @updatedAt @map("updated_at")
  deletedAt DateTime?    @map("deleted_at")
  site      Site         @relation(fields: [siteId], references: [id], onDelete: Cascade)
  page      Page?        @relation(fields: [pageId], references: [id], onDelete: SetNull)
  parent    MenuItem?    @relation("MenuTree", fields: [parentId], references: [id], onDelete: SetNull)
  children  MenuItem[]   @relation("MenuTree")

  @@index([siteId])
  @@index([siteId, setKey])
  @@index([parentId])
  @@index([pageId])
  @@index([siteId, setKey, sortOrder])
  @@index([siteId, visible])
  @@map("menu_items")
}

// ==== part: Order.prisma ====
// ===== Enums =====
enum OrderStatus {
  DRAFT
  PLACED
  CANCELLED
  COMPLETED
}

enum PaymentStatus {
  UNPAID
  PENDING
  PAID
  FAILED
  REFUNDED
  CANCELED
}

enum FulfillmentStatus {
  UNFULFILLED
  PARTIALLY_FULFILLED
  FULFILLED
  CANCELLED
}

enum PaymentDirection {
  CAPTURE
  REFUND
}

enum PaymentTxStatus {
  PENDING
  SUCCEEDED
  FAILED
  CANCELED
}

enum PaymentMethod {
  COD
  CARD
  BANK_TRANSFER
  WALLET
}

enum ShipmentStatus {
  PENDING
  CONFIRMED
  PICKED_UP
  IN_TRANSIT
  OUT_FOR_DELIVERY
  DELIVERED
  FAILED
  RETURNED
}

enum ShippingMethod {
  STANDARD
  EXPRESS
}

// ===== Models =====

model Order {
  id         String  @id @default(cuid())
  siteId     String  @map("site_id")
  customerId String? @map("customer_id")

  orderNumber String @map("order_number")

  status            OrderStatus
  paymentStatus     PaymentStatus     @map("payment_status")
  fulfillmentStatus FulfillmentStatus @map("fulfillment_status")

  currency      String @default("VND")
  subtotalCents Int    @default(0) @map("subtotal_cents")
  discountCents Int    @default(0) @map("discount_cents")
  shippingCents Int    @default(0) @map("shipping_cents")
  taxCents      Int    @default(0) @map("tax_cents")
  totalCents    Int    @default(0) @map("total_cents")

  customerNameSnapshot  String? @map("customer_name_snapshot")
  customerEmailSnapshot String? @map("customer_email_snapshot")
  customerPhoneSnapshot String? @map("customer_phone_snapshot")

  shipToName  String? @map("ship_to_name")
  shipToPhone String? @map("ship_to_phone")
  shipAddr1   String? @map("ship_addr1")
  shipAddr2   String? @map("ship_addr2")
  shipCity    String? @map("ship_city")
  shipRegion  String? @map("ship_region")
  shipPostal  String? @map("ship_postal")
  shipCountry String? @map("ship_country")

  source    String?
  ipAddress String? @map("ip_address")
  userAgent String? @map("user_agent")

  placedAt    DateTime? @map("placed_at")
  paidAt      DateTime? @map("paid_at")
  cancelledAt DateTime? @map("cancelled_at")
  completedAt DateTime? @map("completed_at")

  notes         String?
  internalNotes String? @map("internal_notes")

  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")
  deletedAt DateTime? @map("deleted_at")

  // Relations
  site         Site          @relation(fields: [siteId], references: [id], onDelete: Restrict)
  customer     Customer?     @relation(fields: [customerId], references: [id], onDelete: SetNull)
  items        OrderItem[]
  payments     Payment[]
  fulfillments Fulfillment[]

  @@unique([siteId, orderNumber], map: "uq_orders_site_order_number")
  @@index([siteId, createdAt], map: "idx_orders_site_created_at")
  @@index([siteId, placedAt], map: "idx_orders_site_placed_at")
  @@index([siteId, status], map: "idx_orders_site_status")
  @@index([customerId], map: "idx_orders_customer")
  @@map("orders")
}

model OrderItem {
  id      String @id @default(cuid())
  orderId String @map("order_id")
  siteId  String @map("site_id")

  productId String? @map("product_id")
  variantId String? @map("variant_id")

  productNameSnapshot String  @map("product_name_snapshot")
  variantNameSnapshot String? @map("variant_name_snapshot")
  skuSnapshot         String? @map("sku_snapshot")
  imageSnapshot       String? @map("image_snapshot")

  qty            Int
  unitPriceCents Int @map("unit_price_cents")
  subtotalCents  Int @map("subtotal_cents")
  discountCents  Int @default(0) @map("discount_cents")
  taxCents       Int @default(0) @map("tax_cents")
  totalCents     Int @map("total_cents")

  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")
  deletedAt DateTime? @map("deleted_at")

  // Relations
  order            Order             @relation(fields: [orderId], references: [id], onDelete: Cascade)
  site             Site              @relation(fields: [siteId], references: [id], onDelete: Restrict)
  fulfillmentItems FulfillmentItem[]

  @@index([orderId], map: "idx_order_items_order")
  @@index([siteId, createdAt], map: "idx_order_items_site_created_at")
  @@index([productId], map: "idx_order_items_product")
  @@index([variantId], map: "idx_order_items_variant")
  @@map("order_items")
}

model Payment {
  id      String @id @default(cuid())
  siteId  String @map("site_id")
  orderId String @map("order_id")

  direction PaymentDirection
  status    PaymentTxStatus

  method                PaymentMethod
  provider              String?
  providerTransactionId String?       @map("provider_transaction_id")

  amountCents Int    @map("amount_cents")
  currency    String @default("VND")

  idempotencyKey String? @map("idempotency_key")
  reference      String?

  occurredAt DateTime @map("occurred_at")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  site  Site  @relation(fields: [siteId], references: [id], onDelete: Restrict)
  order Order @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@unique([siteId, idempotencyKey], map: "uq_payments_site_idempotency_key")
  @@index([siteId, occurredAt], map: "idx_payments_site_occurred_at")
  @@index([orderId], map: "idx_payments_order")
  @@map("payments")
}

model Fulfillment {
  id      String @id @default(cuid())
  siteId  String @map("site_id")
  orderId String @map("order_id")

  status ShipmentStatus

  carrier        String?
  trackingNumber String? @map("tracking_number")
  trackingUrl    String? @map("tracking_url")

  estimatedDeliveryAt DateTime? @map("estimated_delivery_at")
  pickedUpAt          DateTime? @map("picked_up_at")
  shippedAt           DateTime? @map("shipped_at")
  outForDeliveryAt    DateTime? @map("out_for_delivery_at")
  deliveredAt         DateTime? @map("delivered_at")
  failedAt            DateTime? @map("failed_at")

  shippingMethod   ShippingMethod @map("shipping_method")
  shippingFeeCents Int            @default(0) @map("shipping_fee_cents")
  notes            String?

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  site  Site              @relation(fields: [siteId], references: [id], onDelete: Restrict)
  order Order             @relation(fields: [orderId], references: [id], onDelete: Cascade)
  items FulfillmentItem[]

  @@index([orderId], map: "idx_fulfillments_order")
  @@index([siteId, status], map: "idx_fulfillments_site_status")
  @@index([trackingNumber], map: "idx_fulfillments_tracking_number")
  @@map("fulfillments")
}

model FulfillmentItem {
  id            String @id @default(cuid())
  fulfillmentId String @map("fulfillment_id")
  orderItemId   String @map("order_item_id")
  qty           Int

  fulfillment Fulfillment @relation(fields: [fulfillmentId], references: [id], onDelete: Cascade)
  orderItem   OrderItem   @relation(fields: [orderItemId], references: [id], onDelete: Restrict)

  @@unique([fulfillmentId, orderItemId], map: "uq_fulfillment_items_unique_pair")
  @@index([fulfillmentId], map: "idx_fulfillment_items_fulfillment")
  @@index([orderItemId], map: "idx_fulfillment_items_order_item")
  @@map("fulfillment_items")
}

// ==== part: Page.prisma ====
enum PageStatus {
  DRAFT
  PUBLISHED
  ARCHIVED
}

model Page {
  id          String     @id @default(cuid())
  siteId      String     @map("site_id")
  title       String
  slug        String
  path        String
  status      PageStatus @default(DRAFT)
  publishedAt DateTime?  @map("published_at")
  blocks      Json?
  seoTitle    String?    @map("seo_title")
  seoDesc     String?    @map("seo_desc")
  sortOrder   Int        @default(0) @map("sort_order")
  createdAt   DateTime   @default(now()) @map("created_at")
  updatedAt   DateTime   @updatedAt @map("updated_at")
  deletedAt   DateTime?  @map("deleted_at")
  site        Site       @relation(fields: [siteId], references: [id], onDelete: Cascade)
  menuItems   MenuItem[]

  @@unique([siteId, slug])
  @@unique([siteId, path])
  @@index([siteId])
  @@index([siteId, status])
  @@index([siteId, publishedAt])
  @@index([siteId, sortOrder])
  @@map("pages")
}

// ==== part: Product.prisma ====
enum ProductStatus {
  DRAFT
  ACTIVE
  ARCHIVED
}

model Product {
  id     String @id @default(cuid())
  siteId String @map("site_id")

  name        String
  slug        String
  description String?

  status ProductStatus @default(DRAFT)

  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")
  deletedAt DateTime? @map("deleted_at")

  // relations
  site         Site                 @relation(fields: [siteId], references: [id], onDelete: Cascade)
  variants     ProductVariant[]
  optionValues ProductOptionValue[]
  images       ProductImage[]
  categoryMap  ProductCategoryMap[]

  @@unique([siteId, slug])
  @@index([siteId])
  @@index([siteId, status])
  @@map("products")
}

model ProductVariant {
  id        String @id @default(cuid())
  productId String @map("product_id")

  // "sku UNIQUE trong site" -> để enforce đúng, cần thêm siteId (denormalize) hoặc unique composite qua relation (Prisma không làm unique join)
  siteId String @map("site_id") // ✅ thêm để unique(sku, siteId) đúng yêu cầu
  sku    String

  price          Decimal  @db.Decimal(12, 2)
  compareAtPrice Decimal? @map("compare_at_price") @db.Decimal(12, 2)

  stockQty Int      @default(0) @map("stock_qty")
  barcode  String?
  weight   Decimal? @db.Decimal(12, 3)

  isDefault Boolean @default(false) @map("is_default")

  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")
  deletedAt DateTime? @map("deleted_at")

  // relations
  product Product        @relation(fields: [productId], references: [id], onDelete: Cascade)
  site    Site           @relation(fields: [siteId], references: [id], onDelete: Cascade)
  images  ProductImage[]

  @@unique([siteId, sku]) // ✅ sku unique trong site
  @@index([productId])
  @@index([siteId])
  @@map("product_variants")
}

model ProductOptionValue {
  id        String @id @default(cuid())
  productId String @map("product_id")

  optionName  String   @map("option_name") // vd: Color, Size
  optionValue String   @map("option_value") // vd: Red, XL
  createdAt   DateTime @default(now()) @map("created_at")

  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  // tuỳ bạn: tránh trùng option y hệt trong 1 product
  @@unique([productId, optionName, optionValue])
  @@index([productId])
  @@map("product_option_values")
}

model ProductImage {
  id        String          @id @default(cuid())
  productId String          @map("product_id")
  variantId String?         @map("variant_id")
  imageUrl  String          @map("image_url")
  sortOrder Int             @default(0) @map("sort_order")
  createdAt DateTime        @default(now()) @map("created_at")
  product   Product         @relation(fields: [productId], references: [id], onDelete: Cascade)
  variant   ProductVariant? @relation(fields: [variantId], references: [id], onDelete: SetNull)

  @@index([productId])
  @@index([variantId])
  @@index([productId, sortOrder])
  @@map("product_images")
}

model ProductCategory {
  id        String               @id @default(cuid())
  siteId    String               @map("site_id")
  name      String
  slug      String
  parentId  String?              @map("parent_id")
  sortOrder Int                  @default(0) @map("sort_order")
  createdAt DateTime             @default(now()) @map("created_at")
  updatedAt DateTime             @updatedAt @map("updated_at")
  site      Site                 @relation(fields: [siteId], references: [id], onDelete: Cascade)
  parent    ProductCategory?     @relation("CategoryTree", fields: [parentId], references: [id], onDelete: SetNull)
  children  ProductCategory[]    @relation("CategoryTree")
  products  ProductCategoryMap[]

  @@unique([siteId, slug])
  @@index([siteId])
  @@index([parentId])
  @@index([siteId, sortOrder])
  @@map("product_categories")
}

model ProductCategoryMap {
  productId  String          @map("product_id")
  categoryId String          @map("category_id")
  product    Product         @relation(fields: [productId], references: [id], onDelete: Cascade)
  category   ProductCategory @relation(fields: [categoryId], references: [id], onDelete: Cascade)

  @@id([productId, categoryId])
  @@index([categoryId])
  @@map("product_category_map")
}

// ==== part: Site.prisma ====
enum SiteStatus {
  DRAFT
  ACTIVE
  SUSPENDED
}

model Site {
  id                      String                  @id @default(cuid())
  name                    String
  domain                  String                  @unique
  ownerUserId             String                  @map("owner_user_id")
  status                  SiteStatus              @default(DRAFT)
  isPublic                Boolean                 @default(false) @map("is_public")
  publishedAt             DateTime?               @map("published_at")
  themeConfig             Json?                   @map("theme_config")
  seoTitleDefault         String?                 @map("seo_title_default")
  seoDescDefault          String?                 @map("seo_desc_default")
  createdAt               DateTime                @default(now()) @map("created_at")
  updatedAt               DateTime                @updatedAt @map("updated_at")
  deletedAt               DateTime?               @map("deleted_at")
  owner                   User                    @relation(fields: [ownerUserId], references: [id], onDelete: Restrict)
  automationRules         AutomationRule[]
  channelConnections      ChannelConnection[]
  automationEventOutboxes AutomationEventOutbox[]
  automationJobRuns       AutomationJobRun[]
  messageTemplates        MessageTemplate[]
  audiences               Audience[]
  customers               Customer[]
  addresses               Address[]
  menuItems               MenuItem[]
  orders                  Order[]
  orderItems              OrderItem[]
  payments                Payment[]
  fulfillments            Fulfillment[]
  pages                   Page[]
  products                Product[]
  productVariants         ProductVariant[]
  productCategories       ProductCategory[]

  @@index([ownerUserId])
  @@index([status])
  @@index([isPublic])
  @@index([publishedAt])
  @@map("sites")
}

// ==== part: user.prisma ====
enum UserRole {
  USER
  SUB_USER
  ADMIN
}

enum UserStatus {
  ACTIVE
  SUSPENDED
}

model User {
  id              String                   @id @default(cuid())
  email           String                   @unique
  passwordHash    String                   @map("password_hash")
  role            UserRole                 @default(USER)
  status          UserStatus               @default(ACTIVE)
  emailVerifiedAt DateTime?                @map("email_verified_at")
  lastLoginAt     DateTime?                @map("last_login_at")
  createdAt       DateTime                 @default(now()) @map("created_at")
  updatedAt       DateTime                 @updatedAt @map("updated_at")
  sessions        UserSession[]
  passwordResets  PasswordResetToken[]
  emailVerifs     EmailVerificationToken[]
  loginAttempts   LoginAttempt[]
  auditActorLogs  AuditLog[]               @relation("AuditActor")
  auditTargetLogs AuditLog[]               @relation("AuditTarget")
  twoFactor       UserTwoFactor?
  backupCodes     UserBackupCode[]
  devices         UserDevice[]
  automationRules AutomationRule[]
  customers       Customer[]
  sites           Site[]

  @@index([role])
  @@index([status])
  @@map("users")
}

model UserSession {
  id                   String        @id @default(cuid())
  userId               String        @map("user_id")
  refreshTokenHash     String        @unique @map("refresh_token_hash")
  expiresAt            DateTime      @map("expires_at")
  revokedAt            DateTime?     @map("revoked_at")
  ipAddress            String?       @map("ip_address")
  userAgent            String?       @map("user_agent")
  deviceId             String?       @map("device_id")
  lastSeenAt           DateTime?     @map("last_seen_at")
  rotatedFromSessionId String?       @map("rotated_from_session_id")
  createdAt            DateTime      @default(now()) @map("created_at")
  updatedAt            DateTime      @updatedAt @map("updated_at")
  user                 User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  rotatedFromSession   UserSession?  @relation("SessionRotation", fields: [rotatedFromSessionId], references: [id])
  rotatedToSessions    UserSession[] @relation("SessionRotation")

  @@index([userId])
  @@index([expiresAt])
  @@index([revokedAt])
  @@map("user_sessions")
}

model PasswordResetToken {
  id        String    @id @default(cuid())
  userId    String    @map("user_id")
  tokenHash String    @unique @map("token_hash")
  expiresAt DateTime  @map("expires_at")
  usedAt    DateTime? @map("used_at")
  createdAt DateTime  @default(now()) @map("created_at")
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([expiresAt])
  @@map("password_reset_tokens")
}

model EmailVerificationToken {
  id        String    @id @default(cuid())
  userId    String    @map("user_id")
  tokenHash String    @map("token_hash")
  expiresAt DateTime  @map("expires_at")
  usedAt    DateTime? @map("used_at")
  createdAt DateTime  @default(now()) @map("created_at")
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([expiresAt])
  @@index([tokenHash])
  @@map("email_verification_tokens")
}

model LoginAttempt {
  id        String   @id @default(cuid())
  email     String?
  userId    String?  @map("user_id")
  ipAddress String   @map("ip_address")
  userAgent String?  @map("user_agent")
  success   Boolean
  createdAt DateTime @default(now()) @map("created_at")
  user      User?    @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([ipAddress, createdAt])
  @@index([email, createdAt])
  @@index([userId, createdAt])
  @@map("login_attempts")
}

model AuditLog {
  id           String   @id @default(cuid())
  actorUserId  String?  @map("actor_user_id")
  action       String
  targetUserId String?  @map("target_user_id")
  ipAddress    String?  @map("ip_address")
  userAgent    String?  @map("user_agent")
  metaJson     Json?    @map("meta_json")
  createdAt    DateTime @default(now()) @map("created_at")
  actorUser    User?    @relation("AuditActor", fields: [actorUserId], references: [id], onDelete: SetNull)
  targetUser   User?    @relation("AuditTarget", fields: [targetUserId], references: [id], onDelete: SetNull)

  @@index([actorUserId, createdAt])
  @@index([action, createdAt])
  @@map("audit_logs")
}

model UserTwoFactor {
  userId     String    @id @map("user_id")
  enabled    Boolean   @default(false)
  secretEnc  String?   @map("secret_enc")
  enabledAt  DateTime? @map("enabled_at")
  lastUsedAt DateTime? @map("last_used_at")
  createdAt  DateTime  @default(now()) @map("created_at")
  updatedAt  DateTime  @updatedAt @map("updated_at")
  user       User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("user_two_factor")
}

model UserBackupCode {
  id        String    @id @default(cuid())
  userId    String    @map("user_id")
  codeHash  String    @map("code_hash")
  usedAt    DateTime? @map("used_at")
  createdAt DateTime  @default(now()) @map("created_at")
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, codeHash])
  @@index([userId])
  @@map("user_backup_codes")
}

model UserDevice {
  id            String    @id @default(cuid())
  userId        String    @map("user_id")
  deviceUid     String    @unique @map("device_uid")
  deviceName    String?   @map("device_name")
  platform      String?
  trusted       Boolean   @default(false)
  firstSeenAt   DateTime  @map("first_seen_at")
  lastSeenAt    DateTime  @map("last_seen_at")
  lastIp        String?   @map("last_ip")
  lastUserAgent String?   @map("last_user_agent")
  revokedAt     DateTime? @map("revoked_at")
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")
  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([userId, trusted])
  @@index([lastSeenAt])
  @@map("user_devices")
}
