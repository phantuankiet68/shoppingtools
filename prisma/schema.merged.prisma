// ==== base ====
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

enum Locale {
  vi
  en
  ja
}

// ==== part: Calendar.prisma ====
enum CalendarEventColor {
  BLUE
  PURPLE
  GREEN
  AMBER
  RED
  TEAL
}

model Calendar {
  id        String  @id @default(cuid())
  ownerId   String
  name      String
  isDefault Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  owner  User            @relation(fields: [ownerId], references: [id], onDelete: Cascade)
  events CalendarEvent[]

  @@unique([ownerId, name])
  @@index([ownerId])
}

model CalendarEvent {
  id         String @id @default(cuid())
  calendarId String
  creatorId  String

  title       String
  description String?
  location    String?

  color CalendarEventColor @default(BLUE)

  allDay  Boolean  @default(false)
  startAt DateTime
  endAt   DateTime

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  calendar Calendar @relation(fields: [calendarId], references: [id], onDelete: Cascade)
  creator  User     @relation("UserCreatedEvents", fields: [creatorId], references: [id], onDelete: Cascade)

  @@index([calendarId, startAt])
  @@index([creatorId, startAt])
}

// ==== part: File.prisma ====

model FileFolder {
  id   String @id @default(cuid())
  name String

  // Tree
  parentId String?
  parent   FileFolder?  @relation("FolderTree", fields: [parentId], references: [id], onDelete: Cascade)
  children FileFolder[] @relation("FolderTree")

  // Ownership (map vào User.folders)
  ownerId String
  owner   User   @relation(fields: [ownerId], references: [id], onDelete: Cascade)

  // Files inside folder
  files StoredFile[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // chống trùng tên folder trong cùng 1 thư mục (theo user)
  @@unique([ownerId, parentId, name])
  @@index([ownerId, parentId])
}

model StoredFile {
  id String @id @default(cuid())

  folderId String?
  folder   FileFolder? @relation(fields: [folderId], references: [id], onDelete: SetNull)

  // Ownership (map vào User.files)
  ownerId String
  owner   User   @relation(fields: [ownerId], references: [id], onDelete: Cascade)

  name       String
  mimeType   String
  sizeBytes  Int
  storageKey String @unique // key để tìm file trong storage private

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([ownerId, folderId])
  @@index([folderId])
}

// ==== part: Image.prisma ====
model ImageFolder {
  id     String @id @default(cuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  name     String
  parentId String?
  parent   ImageFolder?  @relation("ImageFolderTree", fields: [parentId], references: [id], onDelete: SetNull)
  children ImageFolder[] @relation("ImageFolderTree")

  images ImageAsset[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, parentId, name])
  @@unique([id, userId])
  @@index([userId, parentId])
}

model ImageAsset {
  id String @id @default(cuid())

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  folderId String?
  folder   ImageFolder? @relation(fields: [folderId, userId], references: [id, userId], onDelete: Restrict)

  originalName String
  fileName     String
  mimeType     String
  sizeBytes    Int

  width  Int?
  height Int?

  tag ImageTag?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([fileName])
  @@index([userId, createdAt])
  @@index([userId, tag])
}

enum ImageTag {
  NEW
  HDR
  AI
  FAVORITE
  COVER
  BANNER
  AVATAR
  PRODUCT
}

// ==== part: MenuItem.prisma ====
model MenuItem {
  id String @id @default(cuid())

  siteId String
  site   Site   @relation(fields: [siteId], references: [id], onUpdate: Cascade)

  parentId String?    @db.VarChar(191)
  parent   MenuItem?  @relation("MenuItemToSelf", fields: [parentId], references: [id])
  children MenuItem[] @relation("MenuItemToSelf")

  title     String     @db.VarChar(191)
  path      String?    @db.VarChar(255)
  icon      String?    @db.VarChar(100)
  sortOrder Int        @default(0)
  visible   Boolean    @default(true)
  locale    Locale     @default(vi)
  setKey    MenuSetKey @default(home)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([parentId])
  @@index([siteId, locale, setKey, sortOrder])
  @@index([title])
}

enum MenuSetKey {
  home
  v1
}

// ==== part: Message.prisma ====
enum ConversationType {
  DIRECT
  GROUP
}

model Conversation {
  id            String           @id @default(cuid())
  type          ConversationType @default(DIRECT)
  createdAt     DateTime         @default(now())
  updatedAt     DateTime         @updatedAt
  lastMessageAt DateTime?

  members  ConversationMember[]
  messages Message[]

  @@index([type])
  @@index([lastMessageAt])
}

model ConversationMember {
  id             String    @id @default(cuid())
  conversationId String
  userId         String
  role           String    @default("MEMBER")
  joinedAt       DateTime  @default(now())
  lastReadAt     DateTime?

  conversation Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  user         User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([conversationId, userId])
  @@index([userId])
}

model Message {
  id             String   @id @default(cuid())
  conversationId String
  senderId       String
  text           String
  createdAt      DateTime @default(now())

  conversation Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  sender       User         @relation(fields: [senderId], references: [id], onDelete: Cascade)

  @@index([conversationId, createdAt])
}

enum FriendRequestStatus {
  PENDING
  ACCEPTED
  REJECTED
  CANCELED
}

model FriendRequest {
  id          String              @id @default(cuid())
  fromId      String
  toId        String
  status      FriendRequestStatus @default(PENDING)
  createdAt   DateTime            @default(now())
  updatedAt   DateTime            @updatedAt
  respondedAt DateTime?

  from User @relation("FriendReqFrom", fields: [fromId], references: [id], onDelete: Cascade)
  to   User @relation("FriendReqTo", fields: [toId], references: [id], onDelete: Cascade)

  @@unique([fromId, toId])
  @@index([toId, status])
  @@index([fromId, status])
}

model Block {
  id        String   @id @default(cuid())
  blockerId String
  blockedId String
  createdAt DateTime @default(now())

  blocker User @relation("Blocker", fields: [blockerId], references: [id], onDelete: Cascade)
  blocked User @relation("Blocked", fields: [blockedId], references: [id], onDelete: Cascade)

  @@unique([blockerId, blockedId])
  @@index([blockedId])
}

// ==== part: Page.prisma ====
// ==== Page.prisma (đã chỉnh) ====
model Page {
  id                String       @id @default(cuid())
  siteId            String
  site              Site         @relation(fields: [siteId], references: [id], onUpdate: Cascade)
  locale            Locale
  title             String
  slug              String
  path              String
  status            PageStatus   @default(DRAFT)
  blocks            Json
  seoTitle          String?
  seoDesc           String?
  coverImage        String?
  seoKeywords       String?
  canonicalUrl      String?
  noindex           Boolean?     @default(false)
  nofollow          Boolean?     @default(false)
  ogTitle           String?
  ogDescription     String?
  twitterCard       TwitterCard? @default(SUMMARY_LARGE_IMAGE)
  sitemapChangefreq Changefreq?  @default(WEEKLY)
  sitemapPriority   Float?       @default(0.7)
  structuredData    Json?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([siteId, locale, slug])
  @@unique([siteId, path])
  @@index([siteId, locale])
  @@index([siteId, locale, updatedAt])
}

enum PageStatus {
  DRAFT
  PUBLISHED
}

enum TwitterCard {
  SUMMARY
  SUMMARY_LARGE_IMAGE
}

enum Changefreq {
  ALWAYS
  HOURLY
  DAILY
  WEEKLY
  MONTHLY
  YEARLY
  NEVER
}

// ==== part: Profile.prisma ====
// schema.prisma

enum ProfileRole {
  admin
  staff
  viewer
}

enum AccountStatus {
  active
  suspended
}

enum Gender {
  male
  female
  other
}

model Profile {
  id String @id @default(cuid())

  userId String @unique
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  firstName   String?
  lastName    String?
  username    String? @unique
  backupEmail String?
  phone       String?
  address     String?
  city        String?
  country     String?

  role   ProfileRole   @default(viewer)
  status AccountStatus @default(active)

  company    String?
  department String?
  jobTitle   String?
  manager    String?
  hireDate   DateTime?

  gender   Gender? @default(other)
  locale   Locale  @default(vi)
  timezone String  @default("Asia/Ho_Chi_Minh")

  dobMonth String?
  dobDay   Int?
  dobYear  Int?

  twitter  String?
  linkedin String?
  facebook String?
  github   String?
  website  String?

  slogan String?
  bio    String?

  twoFA       Boolean   @default(false)
  lastLoginAt DateTime?
  lastLoginIp String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// ==== part: Site.prisma ====

model Site {
  id            String     @id @default(cuid())
  domain        String     @unique
  name          String
  localeDefault Locale     @default(vi)
  createdAt     DateTime   @default(now())
  updatedAt     DateTime   @updatedAt
  pages         Page[]
  menuItems     MenuItem[]
}

// ==== part: user.prisma ====
enum UserRole {
  USER
  ADMIN
}

enum AuditAction {
  ADMIN_LOGIN_SUCCESS
  ADMIN_LOGIN_FAIL
  ADMIN_LOGOUT
  PASSWORD_CHANGE
  TWOFA_ENABLED
  TWOFA_DISABLED
  TWOFA_CHALLENGE_FAIL
  SESSION_REVOKED
  SESSION_REVOKE_ALL
  ADMIN_SENSITIVE_ACTION
}

enum AuditResult {
  SUCCESS
  FAIL
}

enum SessionType {
  ADMIN
  USER
}

model User {
  id              String    @id @default(cuid())
  email           String    @unique
  emailVerifiedAt DateTime?
  role            UserRole  @default(USER)
  isActive        Boolean   @default(true)

  image String?

  passwordHash      String
  passwordUpdatedAt DateTime @default(now())

  failedLoginCount Int       @default(0)
  lockedUntil      DateTime?

  requireReauthAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  sessions    Session[]
  twoFactor   TwoFactor?
  backupCodes BackupCode[]
  auditLogs   AuditLog[]

  profile Profile?

  // ✅ FRIEND RELATIONS
  friendRequestsSent     FriendRequest[] @relation("FriendReqFrom")
  friendRequestsReceived FriendRequest[] @relation("FriendReqTo")

  // ✅ BLOCK RELATIONS
  blocksSent     Block[] @relation("Blocker")
  blocksReceived Block[] @relation("Blocked")

  calendars      Calendar[]
  calendarEvents CalendarEvent[] @relation("UserCreatedEvents")

  folders FileFolder[]
  files   StoredFile[]

  images              ImageAsset[]
  imageFolders        ImageFolder[]
  conversationMembers ConversationMember[]
  messages            Message[]

  @@index([role])
  @@index([lockedUntil])
}

model Session {
  id           String      @id @default(cuid())
  userId       String
  user         User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  type         SessionType @default(USER)
  tokenHash    String      @unique
  createdAt    DateTime    @default(now())
  expiresAt    DateTime
  lastSeenAt   DateTime    @default(now())
  ip           String?
  userAgent    String?
  country      String?
  revokedAt    DateTime?
  revokeReason String?

  @@index([userId, type])
  @@index([expiresAt])
  @@index([revokedAt])
}

model TwoFactor {
  id         String    @id @default(cuid())
  userId     String    @unique
  user       User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  enabled    Boolean   @default(false)
  secretEnc  String?
  lastUsedAt DateTime?
  enabledAt  DateTime?
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt
}

model BackupCode {
  id        String    @id @default(cuid())
  userId    String
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  codeHash  String
  usedAt    DateTime?
  createdAt DateTime  @default(now())

  @@unique([userId, codeHash])
  @@index([userId, usedAt])
}

model LoginAttempt {
  id          String   @id @default(cuid())
  email       String?
  ip          String
  fingerprint String?
  success     Boolean  @default(false)
  createdAt   DateTime @default(now())

  @@index([ip, createdAt])
  @@index([email, createdAt])
  @@index([fingerprint, createdAt])
}

model AuditLog {
  id        String      @id @default(cuid())
  userId    String?
  user      User?       @relation(fields: [userId], references: [id], onDelete: SetNull)
  action    AuditAction
  result    AuditResult
  ip        String?
  userAgent String?
  metaJson  Json?
  createdAt DateTime    @default(now())

  @@index([userId, createdAt])
  @@index([action, createdAt])
}
