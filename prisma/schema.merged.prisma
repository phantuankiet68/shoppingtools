// ==== base ====
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

enum Locale {
  vi
  en
  ja
}

// ==== part: Calendar.prisma ====
enum CalendarEventColor {
  BLUE
  PURPLE
  GREEN
  AMBER
  RED
  TEAL
}

model Calendar {
  id        String  @id @default(cuid())
  ownerId   String
  name      String
  isDefault Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  owner  User            @relation(fields: [ownerId], references: [id], onDelete: Cascade)
  events CalendarEvent[]

  @@unique([ownerId, name])
  @@index([ownerId])
}

model CalendarEvent {
  id         String @id @default(cuid())
  calendarId String
  creatorId  String

  title       String
  description String?
  location    String?

  color CalendarEventColor @default(BLUE)

  allDay  Boolean  @default(false)
  startAt DateTime
  endAt   DateTime

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  calendar Calendar @relation(fields: [calendarId], references: [id], onDelete: Cascade)
  creator  User     @relation("UserCreatedEvents", fields: [creatorId], references: [id], onDelete: Cascade)

  @@index([calendarId, startAt])
  @@index([creatorId, startAt])
}

// ==== part: File.prisma ====

model FileFolder {
  id   String @id @default(cuid())
  name String

  // Tree
  parentId String?
  parent   FileFolder?  @relation("FolderTree", fields: [parentId], references: [id], onDelete: Cascade)
  children FileFolder[] @relation("FolderTree")

  // Ownership (map vào User.folders)
  ownerId String
  owner   User   @relation(fields: [ownerId], references: [id], onDelete: Cascade)

  // Files inside folder
  files StoredFile[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // chống trùng tên folder trong cùng 1 thư mục (theo user)
  @@unique([ownerId, parentId, name])
  @@index([ownerId, parentId])
}

model StoredFile {
  id String @id @default(cuid())

  folderId String?
  folder   FileFolder? @relation(fields: [folderId], references: [id], onDelete: SetNull)

  // Ownership (map vào User.files)
  ownerId String
  owner   User   @relation(fields: [ownerId], references: [id], onDelete: Cascade)

  name       String
  mimeType   String
  sizeBytes  Int
  storageKey String @unique // key để tìm file trong storage private

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([ownerId, folderId])
  @@index([folderId])
}

// ==== part: Image.prisma ====
model ImageFolder {
  id     String @id @default(cuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  name     String
  parentId String?
  parent   ImageFolder?  @relation("ImageFolderTree", fields: [parentId], references: [id], onDelete: SetNull)
  children ImageFolder[] @relation("ImageFolderTree")

  images ImageAsset[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, parentId, name])
  @@unique([id, userId])
  @@index([userId, parentId])
}

model ImageAsset {
  id String @id @default(cuid())

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  folderId String?
  folder   ImageFolder? @relation(fields: [folderId, userId], references: [id, userId], onDelete: Restrict)

  originalName String
  fileName     String
  mimeType     String
  sizeBytes    Int

  width  Int?
  height Int?

  tag ImageTag?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([fileName])
  @@index([userId, createdAt])
  @@index([userId, tag])
}

enum ImageTag {
  NEW
  HDR
  AI
  FAVORITE
  COVER
  BANNER
  AVATAR
  PRODUCT
}

// ==== part: Integration.prisma ====
enum IntegrationCategory {
  payments
  email
  analytics
  storage
  ai
  crm
}

enum IntegrationStatus {
  disconnected
  connected
  error
}

enum LogLevel {
  info
  warn
  error
}

model Integration {
  id          String              @id @default(cuid())
  key         String              @unique
  name        String
  category    IntegrationCategory
  description String?

  enabled Boolean           @default(false)
  status  IntegrationStatus @default(disconnected)

  config Json @default("{}")

  apiKeyEnc     String?
  apiSecretEnc  String?
  webhookUrlEnc String?

  lastSyncAt DateTime?
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt

  logs IntegrationLog[]
}

model IntegrationLog {
  id            String   @id @default(cuid())
  integrationId String
  level         LogLevel @default(info)
  message       String
  meta          Json     @default("{}")
  createdAt     DateTime @default(now())

  integration Integration @relation(fields: [integrationId], references: [id], onDelete: Cascade)

  @@index([integrationId, createdAt])
}

// ==== part: MenuItem.prisma ====
model MenuItem {
  id String @id @default(cuid())

  siteId String
  site   Site   @relation(fields: [siteId], references: [id], onUpdate: Cascade)

  parentId String?    @db.VarChar(191)
  parent   MenuItem?  @relation("MenuItemToSelf", fields: [parentId], references: [id])
  children MenuItem[] @relation("MenuItemToSelf")

  title     String     @db.VarChar(191)
  path      String?    @db.VarChar(255)
  icon      String?    @db.VarChar(100)
  sortOrder Int        @default(0)
  visible   Boolean    @default(true)
  locale    Locale     @default(vi)
  setKey    MenuSetKey @default(home)

  pages Page[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([parentId])
  @@index([siteId, locale, setKey, sortOrder])
  @@index([title])
}

enum MenuSetKey {
  home
  v1
}

// ==== part: Message.prisma ====
enum ConversationType {
  DIRECT
  GROUP
}

model Conversation {
  id            String           @id @default(cuid())
  type          ConversationType @default(DIRECT)
  createdAt     DateTime         @default(now())
  updatedAt     DateTime         @updatedAt
  lastMessageAt DateTime?

  members  ConversationMember[]
  messages Message[]

  @@index([type])
  @@index([lastMessageAt])
}

model ConversationMember {
  id             String    @id @default(cuid())
  conversationId String
  userId         String
  role           String    @default("MEMBER")
  joinedAt       DateTime  @default(now())
  lastReadAt     DateTime?

  conversation Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  user         User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([conversationId, userId])
  @@index([userId])
}

model Message {
  id             String   @id @default(cuid())
  conversationId String
  senderId       String
  text           String
  createdAt      DateTime @default(now())

  conversation Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  sender       User         @relation(fields: [senderId], references: [id], onDelete: Cascade)

  @@index([conversationId, createdAt])
}

enum FriendRequestStatus {
  PENDING
  ACCEPTED
  REJECTED
  CANCELED
}

model FriendRequest {
  id          String              @id @default(cuid())
  fromId      String
  toId        String
  status      FriendRequestStatus @default(PENDING)
  createdAt   DateTime            @default(now())
  updatedAt   DateTime            @updatedAt
  respondedAt DateTime?

  from User @relation("FriendReqFrom", fields: [fromId], references: [id], onDelete: Cascade)
  to   User @relation("FriendReqTo", fields: [toId], references: [id], onDelete: Cascade)

  @@unique([fromId, toId])
  @@index([toId, status])
  @@index([fromId, status])
}

model Block {
  id        String   @id @default(cuid())
  blockerId String
  blockedId String
  createdAt DateTime @default(now())

  blocker User @relation("Blocker", fields: [blockerId], references: [id], onDelete: Cascade)
  blocked User @relation("Blocked", fields: [blockedId], references: [id], onDelete: Cascade)

  @@unique([blockerId, blockedId])
  @@index([blockedId])
}

// ==== part: Page.prisma ====
model Page {
  id                String      @id @default(cuid())
  siteId            String
  site              Site        @relation(fields: [siteId], references: [id], onUpdate: Cascade, onDelete: Cascade)
  menuItemId        String?     @db.VarChar(191)
  menuItem          MenuItem?   @relation(fields: [menuItemId], references: [id], onDelete: SetNull)
  title             String
  slug              String
  path              String
  status            PageStatus  @default(DRAFT)
  blocks            Json
  seoTitle          String?
  seoDesc           String?
  coverImage        String?
  seoKeywords       String?
  canonicalUrl      String?
  noindex           Boolean     @default(false)
  nofollow          Boolean     @default(false)
  ogTitle           String?
  ogDescription     String?
  twitterCard       TwitterCard @default(SUMMARY_LARGE_IMAGE)
  sitemapChangefreq Changefreq  @default(WEEKLY)
  sitemapPriority   Float       @default(0.7)
  structuredData    Json?
  createdAt         DateTime    @default(now())
  updatedAt         DateTime    @updatedAt
  sections          Section[]

  @@unique([siteId, slug])
  @@unique([siteId, path])
  @@index([siteId])
  @@index([siteId, updatedAt])
  @@index([menuItemId])
}

enum PageStatus {
  DRAFT
  PUBLISHED
}

enum TwitterCard {
  SUMMARY
  SUMMARY_LARGE_IMAGE
}

enum Changefreq {
  ALWAYS
  HOURLY
  DAILY
  WEEKLY
  MONTHLY
  YEARLY
  NEVER
}

model Section {
  id      String  @id @default(cuid())
  pageId  String
  type    String // "hero" | "text" | "gallery"...
  enabled Boolean @default(true)
  sort    Int     @default(0)

  data  Json // nội dung + props
  style Json? // style override (optional)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  page Page @relation(fields: [pageId], references: [id], onDelete: Cascade)

  @@index([pageId, sort])
  @@index([type])
}

// ==== part: Product.prisma ====
enum CurrencyCode {
  USD
  VND
}

enum PaymentMethod {
  CARD
  BANK
  CASH
  EWALLET
  COD
}

enum TxStatus {
  PENDING
  PAID
  REFUNDED
  CANCELLED
}

enum TxType {
  EXPENSE // chi phí
  INCOME // thu nhập (nếu sau này bạn muốn)
  ADJUSTMENT // điều chỉnh
}

enum SpendCategoryType {
  INVENTORY
  SOFTWARE
  MARKETING
  OPS
  TRAVEL
  OFFICE
  OTHER
}

enum ReceiptStatus {
  PENDING
  RECEIVED
  CANCELLED
}

enum SalesChannel {
  SHOP
  MARKETPLACE
  WHOLESALE
}

enum SalesStatus {
  DELIVERING
  DELIVERED
  RETURNED
  CANCELLED
}

enum OrderStatus {
  PENDING
  CONFIRMED
  DELIVERING
  DELIVERED
  CANCELLED
  RETURNED
}

model SpendCategory {
  id       String            @id @default(cuid())
  name     String            @unique
  type     SpendCategoryType @default(OTHER)
  icon     String? // optional: "bi-cash-stack"...
  color    String? // optional: "blue", "#0ea5e9"
  isActive Boolean           @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  transactions Transaction[]
  user         User?         @relation(fields: [userId], references: [id])
  userId       String?

  @@index([type])
}

model Merchant {
  id      String  @id @default(cuid())
  name    String  @unique
  website String?
  email   String?
  phone   String?
  address String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  transactions Transaction[]
  user         User?         @relation(fields: [userId], references: [id])
  userId       String?
}

model Transaction {
  id     String @id @default(cuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  type     TxType        @default(EXPENSE)
  status   TxStatus      @default(PAID)
  method   PaymentMethod @default(CARD)
  currency CurrencyCode  @default(USD)

  title       String
  description String?

  merchantId String?
  merchant   Merchant? @relation(fields: [merchantId], references: [id], onDelete: SetNull)

  categoryId String?
  category   SpendCategory? @relation(fields: [categoryId], references: [id], onDelete: SetNull)

  subtotalCents Int @default(0)
  taxCents      Int @default(0)
  totalCents    Int @default(0)

  occurredAt DateTime
  reference  String?
  notes      String?

  inventoryReceiptId String? @unique

  lines TransactionLine[]

  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt
  inventoryReceipts InventoryReceipt[]

  @@index([userId, occurredAt])
  @@index([status])
  @@index([categoryId])
  @@index([merchantId])
}

model TransactionLine {
  id            String      @id @default(cuid())
  transactionId String
  transaction   Transaction @relation(fields: [transactionId], references: [id], onDelete: Cascade)

  // optional: gắn vào product nếu là mua hàng hoá
  productId String?
  product   Product? @relation(fields: [productId], references: [id], onDelete: SetNull)

  title          String
  qty            Int    @default(1)
  unitPriceCents Int    @default(0)
  totalCents     Int    @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([transactionId])
  @@index([productId])
}

model ProductCategory {
  id     String @id @default(cuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  name     String
  slug     String
  isActive Boolean @default(true)

  parentId String?
  parent   ProductCategory?  @relation("CategoryTree", fields: [parentId], references: [id], onDelete: SetNull)
  children ProductCategory[] @relation("CategoryTree")

  sort Int @default(0)

  icon       String?
  coverImage String?
  seoTitle   String?
  seoDesc    String? @db.Text

  products Product[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, slug])
  @@unique([userId, name])
  @@index([userId])
  @@index([userId, parentId])
  @@index([userId, parentId, sort])
}

model Product {
  id     String @id @default(cuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  name        String
  slug        String
  description String? @db.Text

  sku               String
  barcode           String?
  priceCents        Int     @default(0)
  costCents         Int     @default(0)
  stock             Int     @default(0)
  hasVariants       Boolean @default(false)
  displayPriceCents Int     @default(0)
  displayStock      Int     @default(0)

  isActive Boolean @default(true)

  categoryId String?
  category   ProductCategory? @relation(fields: [categoryId], references: [id], onDelete: SetNull)

  images     ProductImage[]
  attributes ProductAttribute[]

  variants ProductVariant[]

  createdAt             DateTime               @default(now())
  updatedAt             DateTime               @updatedAt
  transactionLines      TransactionLine[]
  inventoryReceiptItems InventoryReceiptItem[]
  orderItems            OrderItem[]

  @@unique([userId, sku])
  @@unique([userId, slug])
  @@unique([userId, barcode])
  @@index([userId])
  @@index([userId, name])
  // NEW: index tối ưu list/filter
  @@index([userId, isActive])
  @@index([userId, hasVariants])
  @@index([userId, categoryId, isActive])
}

model Supplier {
  id     String @id @default(cuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  name    String
  email   String?
  phone   String?
  address String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  receipts InventoryReceipt[]

  @@unique([userId, name])
  @@index([userId])
}

model InventoryReceipt {
  id     String @id @default(cuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  supplierId String?
  supplier   Supplier? @relation(fields: [supplierId], references: [id], onDelete: SetNull)

  status   ReceiptStatus @default(PENDING)
  currency CurrencyCode  @default(USD)

  receivedAt DateTime
  reference  String? // PO / invoice

  subtotalCents Int @default(0)
  taxCents      Int @default(0)
  totalCents    Int @default(0)

  notes String?

  items InventoryReceiptItem[]

  // optional: auto tạo 1 Transaction “Inventory Receipt” cho spending dashboard
  transaction Transaction? @relation(fields: [transactionId], references: [id])

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  transactionId String?

  @@index([userId, receivedAt])
  @@index([status])
  @@index([supplierId])
}

model InventoryReceiptItem {
  id String @id @default(cuid())

  receiptId String
  receipt   InventoryReceipt @relation(fields: [receiptId], references: [id], onDelete: Cascade)

  productId String
  product   Product @relation(fields: [productId], references: [id], onDelete: Restrict)

  variantId String?
  variant   ProductVariant? @relation(fields: [variantId], references: [id], onDelete: Restrict)

  qty           Int
  unitCostCents Int
  totalCents    Int

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([receiptId])
  @@index([productId])
  @@index([variantId])
}

model Customer {
  id     String @id @default(cuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  name  String
  email String?
  phone String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  orders Order[]

  @@unique([userId, name])
  @@index([userId])
}

model ProductImage {
  id String @id @default(cuid())

  productId String
  product   Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  // URL ảnh (đã upload lên /uploads hoặc S3...)
  url String

  // Tên file (optional)
  fileName String?

  // sắp xếp ảnh trong gallery
  sort Int @default(0)

  // ảnh cover (optional nhưng rất hữu ích)
  isCover Boolean @default(false)

  createdAt DateTime @default(now())

  @@index([productId])
  @@index([productId, sort])
}

model ProductAttribute {
  id String @id @default(cuid())

  productId String
  product   Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  key   String // ví dụ: "Chất liệu"
  value String // ví dụ: "Cotton"
  sort  Int    @default(0)

  @@index([productId, sort])
}

model Order {
  id     String @id @default(cuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  customerId String?
  customer   Customer? @relation(fields: [customerId], references: [id], onDelete: SetNull)

  status   OrderStatus  @default(PENDING)
  currency CurrencyCode @default(VND)

  subtotalCents Int @default(0)
  shippingCents Int @default(0)
  totalCents    Int @default(0)

  items OrderItem[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId, createdAt])
  @@index([status])
}

model OrderItem {
  id String @id @default(cuid())

  orderId String
  order   Order  @relation(fields: [orderId], references: [id], onDelete: Cascade)

  productId String
  product   Product @relation(fields: [productId], references: [id], onDelete: Restrict)

  variantId String?
  variant   ProductVariant? @relation(fields: [variantId], references: [id], onDelete: SetNull)

  qty        Int
  priceCents Int
  totalCents Int

  @@index([orderId])
  @@index([productId])
  @@index([variantId])
}

enum VariantStatus {
  ACTIVE
  INACTIVE
}

model ProductVariant {
  id String @id @default(cuid())

  productId String
  product   Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  name    String? // ví dụ: "Đen"
  sku     String
  barcode String?

  priceCents Int @default(0)
  costCents  Int @default(0)

  // inventory
  stock    Int     @default(0)
  isActive Boolean @default(true)

  option1 String? // "Color"
  value1  String? // "Black"
  option2 String?
  value2  String?

  images ProductVariantImage[]

  createdAt             DateTime               @default(now())
  updatedAt             DateTime               @updatedAt
  inventoryReceiptItems InventoryReceiptItem[]
  orderItems            OrderItem[]

  @@unique([productId, sku])
  @@index([productId])
  @@index([productId, isActive])
}

model ProductVariantImage {
  id String @id @default(cuid())

  variantId String
  variant   ProductVariant @relation(fields: [variantId], references: [id], onDelete: Cascade)

  url      String
  fileName String?
  sort     Int     @default(0)
  isCover  Boolean @default(false)

  createdAt DateTime @default(now())

  @@index([variantId])
  @@index([variantId, sort])
}

// ==== part: Profile.prisma ====
// schema.prisma

enum ProfileRole {
  admin
  staff
  viewer
}

enum AccountStatus {
  active
  suspended
}

enum Gender {
  male
  female
  other
}

model Profile {
  id String @id @default(cuid())

  userId String @unique
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  firstName   String?
  lastName    String?
  username    String? @unique
  backupEmail String?
  phone       String?
  address     String?
  city        String?
  country     String?

  role   ProfileRole   @default(viewer)
  status AccountStatus @default(active)

  company    String?
  department String?
  jobTitle   String?
  manager    String?
  hireDate   DateTime?

  gender   Gender? @default(other)
  locale   Locale  @default(vi)
  timezone String  @default("Asia/Ho_Chi_Minh")

  dobMonth String?
  dobDay   Int?
  dobYear  Int?

  twitter  String?
  linkedin String?
  facebook String?
  github   String?
  website  String?

  slogan String?
  bio    String?

  twoFA       Boolean   @default(false)
  lastLoginAt DateTime?
  lastLoginIp String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// ==== part: Site.prisma ====
model Site {
  id        String     @id @default(cuid())
  domain    String     @unique
  name      String
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt
  pages     Page[]
  menuItems MenuItem[]
}

// ==== part: user.prisma ====
enum UserRole {
  USER
  ADMIN
}

enum AuditAction {
  ADMIN_LOGIN_SUCCESS
  ADMIN_LOGIN_FAIL
  ADMIN_LOGOUT
  PASSWORD_CHANGE
  TWOFA_ENABLED
  TWOFA_DISABLED
  TWOFA_CHALLENGE_FAIL
  SESSION_REVOKED
  SESSION_REVOKE_ALL
  ADMIN_SENSITIVE_ACTION
}

enum AuditResult {
  SUCCESS
  FAIL
}

enum SessionType {
  ADMIN
  USER
}

model User {
  id              String    @id @default(cuid())
  email           String    @unique
  emailVerifiedAt DateTime?
  role            UserRole  @default(USER)
  isActive        Boolean   @default(true)

  image String?

  passwordHash      String
  passwordUpdatedAt DateTime @default(now())

  failedLoginCount Int       @default(0)
  lockedUntil      DateTime?

  requireReauthAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  sessions    Session[]
  twoFactor   TwoFactor?
  backupCodes BackupCode[]
  auditLogs   AuditLog[]

  profile Profile?

  // ✅ FRIEND RELATIONS
  friendRequestsSent     FriendRequest[] @relation("FriendReqFrom")
  friendRequestsReceived FriendRequest[] @relation("FriendReqTo")

  // ✅ BLOCK RELATIONS
  blocksSent     Block[] @relation("Blocker")
  blocksReceived Block[] @relation("Blocked")

  calendars      Calendar[]
  calendarEvents CalendarEvent[] @relation("UserCreatedEvents")

  folders FileFolder[]
  files   StoredFile[]

  images       ImageAsset[]
  imageFolders ImageFolder[]

  // Spending / finance
  transactions    Transaction[]
  spendCategories SpendCategory[]
  merchants       Merchant[]

  // Inventory / sales
  products          Product[]
  suppliers         Supplier[]
  inventoryReceipts InventoryReceipt[]

  customers           Customer[]
  orders              Order[]
  conversationMembers ConversationMember[]
  messages            Message[]
  productCategories   ProductCategory[]

  @@index([role])
  @@index([lockedUntil])
}

model Session {
  id           String      @id @default(cuid())
  userId       String
  user         User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  type         SessionType @default(USER)
  tokenHash    String      @unique
  createdAt    DateTime    @default(now())
  expiresAt    DateTime
  lastSeenAt   DateTime    @default(now())
  ip           String?
  userAgent    String?
  country      String?
  revokedAt    DateTime?
  revokeReason String?

  @@index([userId, type])
  @@index([expiresAt])
  @@index([revokedAt])
}

model TwoFactor {
  id         String    @id @default(cuid())
  userId     String    @unique
  user       User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  enabled    Boolean   @default(false)
  secretEnc  String?
  lastUsedAt DateTime?
  enabledAt  DateTime?
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt
}

model BackupCode {
  id        String    @id @default(cuid())
  userId    String
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  codeHash  String
  usedAt    DateTime?
  createdAt DateTime  @default(now())

  @@unique([userId, codeHash])
  @@index([userId, usedAt])
}

model LoginAttempt {
  id          String   @id @default(cuid())
  email       String?
  ip          String
  fingerprint String?
  success     Boolean  @default(false)
  createdAt   DateTime @default(now())

  @@index([ip, createdAt])
  @@index([email, createdAt])
  @@index([fingerprint, createdAt])
}

model AuditLog {
  id        String      @id @default(cuid())
  userId    String?
  user      User?       @relation(fields: [userId], references: [id], onDelete: SetNull)
  action    AuditAction
  result    AuditResult
  ip        String?
  userAgent String?
  metaJson  Json?
  createdAt DateTime    @default(now())

  @@index([userId, createdAt])
  @@index([action, createdAt])
}
