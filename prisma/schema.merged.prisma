// ==== base ====
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

enum Locale {
  vi
  en
  ja
}


// ==== part: Address.prisma ====
enum AddressType {
  SHIPPING
  BILLING
}

enum AddressStatus {
  ACTIVE
  INACTIVE
}

model Address {
  id         String   @id @default(cuid())
  userId     String?
  user       User?    @relation(fields: [userId], references: [id], onDelete: SetNull)
  customerId String?
  customer   Customer? @relation(fields: [customerId], references: [id], onDelete: SetNull)
  label      String?
  type       AddressType   @default(SHIPPING)
  status     AddressStatus @default(ACTIVE)
  isDefault  Boolean  @default(false)
  receiverName String
  phone        String?
  email        String?
  line1      String
  line2      String?
  ward       String?
  district   String?
  city       String
  region     String?
  country    String    @default("VN")
  postalCode String?
  notes      String?
  meta       Json?
  deletedAt  DateTime?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  @@index([userId, customerId, createdAt])
  @@index([customerId, type, isDefault])
  @@index([status, updatedAt])
  @@index([country, city])
}


// ==== part: Brand.prisma ====
model Brand {
  id        String   @id @default(cuid())
  siteId    String?
  name      String
  slug      String
  image     String?  @db.VarChar(2048)
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  @@index([siteId])
  @@index([slug])
}


// ==== part: Calendar.prisma ====
enum CalendarEventColor {
  BLUE
  PURPLE
  GREEN
  AMBER
  RED
  TEAL
}

model Calendar {
  id        String   @id @default(cuid())
  ownerId   String
  name      String
  isDefault Boolean  @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  owner     User     @relation(fields: [ownerId], references: [id], onDelete: Cascade)
  events    CalendarEvent[]

  @@index([ownerId])
  @@unique([ownerId, name])
}

model CalendarEvent {
  id          String   @id @default(cuid())
  calendarId  String
  creatorId   String

  title       String
  description String?
  location    String?

  color       CalendarEventColor @default(BLUE)

  allDay      Boolean  @default(false)
  startAt     DateTime
  endAt       DateTime

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  calendar    Calendar @relation(fields: [calendarId], references: [id], onDelete: Cascade)
  creator     User     @relation("UserCreatedEvents", fields: [creatorId], references: [id], onDelete: Cascade)

  @@index([calendarId, startAt])
  @@index([creatorId, startAt])
}


// ==== part: Customer.prisma ====
model Customer {
  id        String   @id @default(cuid())

  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  name      String
  phone     String?
  email     String?


  address1  String?
  address2  String?
  city      String?
  state     String?
  postal    String?
  country   String?

  notes     String?   @db.Text
  tags      String?
  isActive  Boolean   @default(true)

  orders    Order[]
  addresses Address[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, phone])
  @@unique([userId, email])

  @@index([userId])
  @@index([userId, name])
  @@index([userId, phone])
  @@index([userId, email])
  @@index([isActive])
}


// ==== part: Email.prisma ====
enum EmailStatus {
  DRAFT
  QUEUED
  SENDING
  SENT
  FAILED
  CANCELLED
}

enum EmailType {
  SYSTEM
  MARKETING
  TRANSACTIONAL
  INTERNAL
}


model Email {
  id            String      @id @default(cuid())

  userId String
  user   User @relation(fields: [userId], references: [id], onDelete: Cascade)

  type          EmailType   @default(SYSTEM)
  status        EmailStatus @default(DRAFT)

  subject       String
  previewText   String?
  htmlContent   String?     @db.LongText
  textContent   String?     @db.Text

  templateKey   String?
  templateData  Json?

  fromName      String?
  fromEmail     String?

  scheduledAt   DateTime?
  sentAt        DateTime?

  totalRecipients Int       @default(0)
  successCount   Int        @default(0)
  failedCount    Int        @default(0)

  lastError     String?     @db.Text

  recipients    EmailRecipient[]

  createdBy     String?
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt

  @@index([userId])
  @@index([userId, status])
  @@index([userId, type])
  @@index([userId, scheduledAt])
  @@index([userId, createdAt])
}


model EmailRecipient {
  id          String      @id @default(cuid())

  emailId     String
  email       Email       @relation(fields: [emailId], references: [id], onDelete: Cascade)

  toEmail     String
  toName      String?

  status      EmailStatus @default(QUEUED)
  sentAt      DateTime?
  error       String?     @db.Text

  openedAt    DateTime?
  clickedAt   DateTime?

  providerMessageId String?

  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@index([emailId])
  @@index([toEmail])
  @@index([status])
}

model EmailTemplate {
  id        String @id @default(cuid())

  userId    String
  user      User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  key       String
  name      String
  subject   String

  htmlContent String? @db.LongText
  textContent String? @db.Text

  description String?
  isActive    Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, key])
  @@index([userId])
  @@index([userId, isActive])
}


// ==== part: File.prisma ====

model FileFolder {
  id         String      @id @default(cuid())
  name       String

  // Tree
  parentId   String?
  parent     FileFolder? @relation("FolderTree", fields: [parentId], references: [id], onDelete: Cascade)
  children   FileFolder[] @relation("FolderTree")

  // Ownership (map vào User.folders)
  ownerId    String
  owner      User         @relation(fields: [ownerId], references: [id], onDelete: Cascade)

  // Files inside folder
  files      StoredFile[]

  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@index([ownerId, parentId])

  @@unique([ownerId, parentId, name])
}

model StoredFile {
  id         String   @id @default(cuid())

  folderId   String?
  folder     FileFolder? @relation(fields: [folderId], references: [id], onDelete: SetNull)

  // Ownership (map vào User.files)
  ownerId    String
  owner      User     @relation(fields: [ownerId], references: [id], onDelete: Cascade)

  name       String
  mimeType   String
  sizeBytes  Int
  storageKey String   @unique  // key để tìm file trong storage private

  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@index([ownerId, folderId])
  @@index([folderId])
}


// ==== part: Image.prisma ====
model ImageFolder {
  id        String @id @default(cuid())
  userId    String
  user      User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  name      String
  parentId  String?
  parent    ImageFolder? @relation("ImageFolderTree", fields: [parentId], references: [id], onDelete: SetNull)
  children  ImageFolder[] @relation("ImageFolderTree")

  images    ImageAsset[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId, parentId])
  @@unique([userId, parentId, name])

  @@unique([id, userId])
}

model ImageAsset {
  id       String @id @default(cuid())

  userId   String
  user     User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  folderId String?
  folder   ImageFolder? @relation(fields: [folderId, userId], references: [id, userId], onDelete: Restrict)

  originalName String
  fileName     String
  mimeType     String
  sizeBytes    Int

  width   Int?
  height  Int?

  tag     ImageTag?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId, createdAt])
  @@index([userId, tag])
  @@unique([fileName])
}


enum ImageTag {
  NEW
  HDR
  AI
  FAVORITE
  COVER
  BANNER
  AVATAR
  PRODUCT
}


// ==== part: Integration.prisma ====
enum IntegrationCategory {
  payments
  email
  analytics
  storage
  ai
  crm
}

enum IntegrationStatus {
  disconnected
  connected
  error
}

enum LogLevel {
  info
  warn
  error
}

model Integration {
  id          String              @id @default(cuid())
  key         String              @unique
  name        String
  category    IntegrationCategory
  description String?

  enabled     Boolean             @default(false)
  status      IntegrationStatus   @default(disconnected)

  config      Json                @default("{}")

  apiKeyEnc      String?
  apiSecretEnc   String?
  webhookUrlEnc  String?

  lastSyncAt   DateTime?
  createdAt    DateTime            @default(now())
  updatedAt    DateTime            @updatedAt

  logs         IntegrationLog[]
}

model IntegrationLog {
  id            String       @id @default(cuid())
  integrationId String
  level         LogLevel     @default(info)
  message       String
  meta          Json         @default("{}")
  createdAt     DateTime     @default(now())

  integration   Integration  @relation(fields: [integrationId], references: [id], onDelete: Cascade)

  @@index([integrationId, createdAt])
}


// ==== part: MenuItem.prisma ====
model MenuItem {
  id        String     @id @default(cuid())

  siteId    String
  site      Site       @relation(fields: [siteId], references: [id], onUpdate: Cascade)

  parentId  String?    @db.VarChar(191)
  parent    MenuItem?  @relation("MenuItemToSelf", fields: [parentId], references: [id])
  children  MenuItem[] @relation("MenuItemToSelf")

  title     String     @db.VarChar(191)
  path      String?    @db.VarChar(255)
  icon      String?    @db.VarChar(100)
  sortOrder Int        @default(0)
  visible   Boolean    @default(true)
  locale    Locale     @default(vi)
  setKey    MenuSetKey @default(home)

  pages     Page[]

  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt

  @@index([parentId])
  @@index([siteId, locale, setKey, sortOrder])
  @@index([title])
}

enum MenuSetKey {
  home
  v1
}


// ==== part: Message.prisma ====
enum ConversationType {
  DIRECT
  GROUP
}

model Conversation {
  id            String           @id @default(cuid())
  type          ConversationType @default(DIRECT)
  createdAt     DateTime         @default(now())
  updatedAt     DateTime         @updatedAt
  lastMessageAt DateTime?

  members  ConversationMember[]
  messages Message[]

  @@index([type])
  @@index([lastMessageAt])
}

model ConversationMember {
  id             String        @id @default(cuid())
  conversationId String
  userId         String
  role           String        @default("MEMBER")
  joinedAt       DateTime      @default(now())
  lastReadAt     DateTime?

  conversation Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  user         User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([conversationId, userId])
  @@index([userId])
}

model Message {
  id             String   @id @default(cuid())
  conversationId String
  senderId       String
  text           String
  createdAt      DateTime @default(now())

  conversation Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  sender       User         @relation(fields: [senderId], references: [id], onDelete: Cascade)

  @@index([conversationId, createdAt])
}

enum FriendRequestStatus {
  PENDING
  ACCEPTED
  REJECTED
  CANCELED
}

model FriendRequest {
  id          String              @id @default(cuid())
  fromId      String
  toId        String
  status      FriendRequestStatus @default(PENDING)
  createdAt   DateTime            @default(now())
  updatedAt   DateTime            @updatedAt
  respondedAt DateTime?

  from User @relation("FriendReqFrom", fields: [fromId], references: [id], onDelete: Cascade)
  to   User @relation("FriendReqTo", fields: [toId], references: [id], onDelete: Cascade)

  @@unique([fromId, toId])
  @@index([toId, status])
  @@index([fromId, status])
}

model Block {
  id        String   @id @default(cuid())
  blockerId String
  blockedId String
  createdAt DateTime @default(now())

  blocker User @relation("Blocker", fields: [blockerId], references: [id], onDelete: Cascade)
  blocked User @relation("Blocked", fields: [blockedId], references: [id], onDelete: Cascade)

  @@unique([blockerId, blockedId])
  @@index([blockedId])
}


// ==== part: Page.prisma ====
model Page {
  id        String     @id @default(cuid())

  siteId    String
  site      Site       @relation(fields: [siteId], references: [id], onUpdate: Cascade, onDelete: Cascade)

  // keep as plain id (no relation)
  menuItemId String?   @db.VarChar(191)

  title     String
  slug      String
  path      String
  status    PageStatus @default(DRAFT)
  blocks    Json

  seoTitle          String?
  seoDesc           String?
  coverImage        String?
  seoKeywords       String?
  canonicalUrl      String?

  noindex           Boolean      @default(false)
  nofollow          Boolean      @default(false)

  ogTitle           String?
  ogDescription     String?

  twitterCard       TwitterCard  @default(SUMMARY_LARGE_IMAGE)
  sitemapChangefreq Changefreq   @default(WEEKLY)
  sitemapPriority   Float        @default(0.7)

  structuredData    Json?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([siteId, slug])
  @@unique([siteId, path])

  @@index([siteId])
  @@index([siteId, updatedAt])
  @@index([menuItemId])
}

enum PageStatus {
  DRAFT
  PUBLISHED
}

enum TwitterCard {
  SUMMARY
  SUMMARY_LARGE_IMAGE
}

enum Changefreq {
  ALWAYS
  HOURLY
  DAILY
  WEEKLY
  MONTHLY
  YEARLY
  NEVER
}

model Section {
  id        String   @id @default(cuid())

  // keep as plain id (no relation)
  pageId    String

  type      String
  enabled   Boolean  @default(true)
  sort      Int      @default(0)

  data      Json
  style     Json?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([pageId, sort])
  @@index([type])
}


// ==== part: Payment.prisma ====
enum PageStatus {
  DRAFT
  PUBLISHED
}

enum TwitterCard {
  SUMMARY
  SUMMARY_LARGE_IMAGE
}

enum Changefreq {
  ALWAYS
  HOURLY
  DAILY
  WEEKLY
  MONTHLY
  YEARLY
  NEVER
}

model Page {
  id        String     @id @default(cuid())

  siteId    String
  site      Site       @relation(fields: [siteId], references: [id], onUpdate: Cascade, onDelete: Cascade)

  // keep as plain id (no relation)
  menuItemId String?   @db.VarChar(191)

  title     String
  slug      String
  path      String
  status    PageStatus @default(DRAFT)
  blocks    Json

  seoTitle          String?
  seoDesc           String?
  coverImage        String?
  seoKeywords       String?
  canonicalUrl      String?

  noindex           Boolean      @default(false)
  nofollow          Boolean      @default(false)

  ogTitle           String?
  ogDescription     String?

  twitterCard       TwitterCard  @default(SUMMARY_LARGE_IMAGE)
  sitemapChangefreq Changefreq   @default(WEEKLY)
  sitemapPriority   Float        @default(0.7)

  structuredData    Json?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([siteId, slug])
  @@unique([siteId, path])

  @@index([siteId])
  @@index([siteId, updatedAt])
  @@index([menuItemId])
}

model Section {
  id        String   @id @default(cuid())

  // keep as plain id (no relation)
  pageId    String?

  type      String   // "hero" | "text" | "gallery"...
  enabled   Boolean  @default(true)
  sort      Int      @default(0)

  data      Json
  style     Json?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([pageId, sort])
  @@index([type])
}


// ==== part: Product.prisma ====
enum CurrencyCode {
  USD
  VND
}

enum PaymentMethod {
  CARD
  BANK
  CASH
  EWALLET
  COD
}

enum TxStatus {
  PENDING
  PAID
  REFUNDED
  CANCELLED
}

enum TxType {
  EXPENSE
  INCOME
  ADJUSTMENT
}

enum SpendCategoryType {
  INVENTORY
  SOFTWARE
  MARKETING
  OPS
  TRAVEL
  OFFICE
  OTHER
}

enum ReceiptStatus {
  PENDING
  RECEIVED
  CANCELLED
}

enum SalesChannel {
  SHOP
  MARKETPLACE
  WHOLESALE
}

enum SalesStatus {
  DELIVERING
  DELIVERED
  RETURNED
  CANCELLED
}

enum OrderStatus {
  PENDING
  CONFIRMED
  DELIVERING
  DELIVERED
  CANCELLED
  RETURNED
}

enum PaymentStatus {
  UNPAID
  PARTIAL
  PAID
  REFUNDED
  CANCELLED
}

enum FulfillmentStatus {
  UNFULFILLED
  PARTIAL
  FULFILLED
  CANCELLED
  RETURNED
}

model SpendCategory {
  id        String            @id @default(cuid())
  name      String            @unique
  type      SpendCategoryType @default(OTHER)
  icon      String?
  color     String?
  isActive  Boolean           @default(true)

  createdAt DateTime          @default(now())
  updatedAt DateTime          @updatedAt

  @@index([type])
}

model Merchant {
  id        String   @id @default(cuid())
  name      String   @unique
  website   String?
  email     String?
  phone     String?
  address   String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Transaction {
  id            String        @id @default(cuid())

  userId        String
  user          User          @relation(fields: [userId], references: [id], onDelete: Cascade)

  type          TxType        @default(EXPENSE)
  status        TxStatus      @default(PAID)
  method        PaymentMethod @default(CARD)
  currency      CurrencyCode  @default(USD)

  title         String
  description   String?

  merchantId    String?
  categoryId    String?

  subtotalCents Int           @default(0)
  taxCents      Int           @default(0)
  totalCents    Int           @default(0)

  occurredAt    DateTime
  reference     String?
  notes         String?

  inventoryReceiptId String? @unique

  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@index([userId, occurredAt])
  @@index([status])
  @@index([categoryId])
  @@index([merchantId])
}

model TransactionLine {
  id             String   @id @default(cuid())

  transactionId  String?
  productId      String?

  title          String
  qty            Int      @default(1)
  unitPriceCents Int      @default(0)
  totalCents     Int      @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([transactionId])
  @@index([productId])
}

model ProductCategory {
  id        String @id @default(cuid())

  userId    String
  user      User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  siteId    String

  name      String
  slug      String
  isActive  Boolean @default(true)

  parentId  String?

  sort      Int @default(0)

  icon      String?
  coverImage String?
  seoTitle  String?
  seoDesc   String? @db.Text

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, slug])
  @@unique([userId, name])
  @@index([userId])
  @@index([userId, parentId])
  @@index([userId, parentId, sort])
}

model Product {
  id        String @id @default(cuid())

  userId    String
  user      User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  name        String
  slug        String
  description String? @db.Text

  sku       String
  barcode   String?

  priceCents Int @default(0)
  costCents  Int @default(0)
  stock      Int @default(0)

  hasVariants       Boolean @default(false)
  displayPriceCents Int     @default(0)
  displayStock      Int     @default(0)

  isActive   Boolean @default(true)

  categoryId String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, sku])
  @@unique([userId, slug])
  @@unique([userId, barcode])
  @@index([userId])
  @@index([userId, name])
  @@index([userId, isActive])
  @@index([userId, hasVariants])
  @@index([userId, categoryId, isActive])
}

model Supplier {
  id        String   @id @default(cuid())

  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  name      String
  email     String?
  phone     String?
  address   String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, name])
  @@index([userId])
}

model InventoryReceipt {
  id          String        @id @default(cuid())

  userId      String
  user        User          @relation(fields: [userId], references: [id], onDelete: Cascade)

  supplierId  String?
  poId        String?

  status      ReceiptStatus @default(PENDING)
  currency    CurrencyCode  @default(USD)

  receivedAt  DateTime?
  reference   String?

  subtotalCents Int @default(0)
  taxCents      Int @default(0)
  totalCents    Int @default(0)

  notes       String?

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([userId, createdAt])
  @@index([userId, receivedAt])
  @@index([status])
  @@index([supplierId])
  @@index([userId, supplierId])

  @@index([poId])
  @@index([userId, poId])
}

model InventoryReceiptItem {
  id        String @id @default(cuid())

  receiptId String?
  poLineId  String?

  productId String?
  variantId String?

  qty           Int
  unitCostCents Int
  totalCents    Int

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([receiptId])
  @@index([productId])
  @@index([variantId])
  @@index([productId, createdAt])
  @@index([variantId, createdAt])

  @@index([poLineId])
}

model ProductImage {
  id        String   @id @default(cuid())

  productId String?

  url       String
  fileName  String?
  sort      Int      @default(0)
  isCover   Boolean  @default(false)

  createdAt DateTime @default(now())

  @@index([productId])
  @@index([productId, sort])
}

model ProductAttribute {
  id        String @id @default(cuid())

  productId String?

  key       String
  value     String
  sort      Int      @default(0)

  @@index([productId, sort])
}

model Order {
  id        String @id @default(cuid())

  userId    String
  user      User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  customerId String?
  customer   Customer? @relation(fields: [customerId], references: [id], onDelete: SetNull)

  status     OrderStatus @default(PENDING)

  paymentStatus     PaymentStatus     @default(UNPAID)
  fulfillmentStatus FulfillmentStatus @default(UNFULFILLED)

  channel   SalesChannel @default(SHOP)
  currency  CurrencyCode @default(VND)

  subtotalCents Int @default(0)
  discountCents Int @default(0)
  shippingCents Int @default(0)
  taxCents      Int @default(0)
  totalCents    Int @default(0)

  number     String?
  reference  String?

  customerNameSnapshot  String?
  customerPhoneSnapshot String?
  customerEmailSnapshot String?

  shipToName     String?
  shipToPhone    String?
  shipToAddress1 String?
  shipToAddress2 String?
  shipToCity     String?
  shipToState    String?
  shipToPostal   String?
  shipToCountry  String?

  carrier      String?
  trackingCode String?
  shippedAt    DateTime?
  deliveredAt  DateTime?
  cancelledAt  DateTime?
  returnedAt   DateTime?

  notes     String?
  tags      String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId, createdAt])
  @@index([status])
  @@index([paymentStatus])
  @@index([fulfillmentStatus])
  @@index([userId, customerId])
  @@unique([userId, number])
}

model OrderItem {
  id        String @id @default(cuid())

  orderId   String?
  productId String?
  variantId String?

  qty        Int

  qtyReserved Int @default(0)
  qtyShipped  Int @default(0)
  qtyReturned Int @default(0)

  unitPriceCents Int
  subtotalCents  Int @default(0)
  discountCents  Int @default(0)
  taxCents       Int @default(0)
  totalCents     Int @default(0)

  skuSnapshot         String?
  productNameSnapshot String?
  variantNameSnapshot String?

  note String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([orderId])
  @@index([productId])
  @@index([variantId])
}

enum VariantStatus {
  ACTIVE
  INACTIVE
}

model ProductVariant {
  id        String   @id @default(cuid())

  productId String?

  name      String?
  sku       String
  barcode   String?

  priceCents Int @default(0)
  costCents  Int @default(0)

  stock     Int @default(0)
  isActive  Boolean @default(true)

  option1   String?
  value1    String?
  option2   String?
  value2    String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([productId, sku])
  @@index([productId])
  @@index([productId, isActive])
}

model ProductVariantImage {
  id        String @id @default(cuid())

  variantId String?

  url       String
  fileName  String?
  sort      Int     @default(0)
  isCover   Boolean @default(false)

  createdAt DateTime @default(now())

  @@index([variantId])
  @@index([variantId, sort])
}

enum StockMovementType {
  IN
  OUT
  ADJUST
  RETURN_IN
  VOID
}

enum StockMovementSource {
  RECEIPT
  ORDER
  MANUAL
}

model StockMovement {
  id        String @id @default(cuid())

  userId    String
  user      User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  productId String?
  variantId String?

  type      StockMovementType
  source    StockMovementSource

  qtyDelta  Int
  occurredAt DateTime

  beforeStock Int?
  afterStock  Int?

  note      String?
  reference String?

  receiptItemId String?
  orderItemId   String?

  idempotencyKey String?

  createdAt DateTime @default(now())

  @@index([userId, occurredAt])
  @@index([productId, occurredAt])
  @@index([variantId, occurredAt])
  @@index([orderItemId, occurredAt])

  @@unique([receiptItemId])
  // REMOVE: @@unique([orderItemId])
  @@unique([idempotencyKey])
}

enum POStatus {
  DRAFT
  APPROVED
  PARTIAL
  RECEIVED
  CANCELLED
}

model PurchaseOrder {
  id         String   @id @default(cuid())

  userId     String
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  number     String
  status     POStatus @default(DRAFT)

  supplierId String?

  currency   CurrencyCode @default(USD)
  expectedAt DateTime?
  notes      String?

  subtotalCents Int @default(0)
  taxCents      Int @default(0)
  totalCents    Int @default(0)

  approvedAt DateTime?
  cancelledAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, number])
  @@index([userId, createdAt])
  @@index([status])
  @@index([supplierId])
}

model PurchaseOrderLine {
  id        String @id @default(cuid())

  poId      String?
  productId String?
  variantId String?

  skuSnapshot  String?
  nameSnapshot String?

  qtyOrdered   Int
  qtyReceived  Int @default(0)

  unitCostCents Int @default(0)
  totalCents    Int @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([poId])
  @@index([productId])
  @@index([variantId])
}


// ==== part: Profile.prisma ====
// schema.prisma

enum ProfileRole  {
  admin
  staff
  viewer
}

enum AccountStatus {
  active
  suspended
}

enum Gender {
  male
  female
  other
}

model Profile {
  id     String @id @default(cuid())

  userId String @unique
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  firstName   String?
  lastName    String?
  username    String? @unique
  backupEmail String?
  phone       String?
  address     String?
  city        String?
  country     String?

  role   ProfileRole   @default(viewer)
  status AccountStatus @default(active)

  company     String?
  department  String?
  jobTitle    String?
  manager     String?
  hireDate    DateTime?

  gender   Gender? @default(other)
  locale   Locale  @default(vi)
  timezone String  @default("Asia/Ho_Chi_Minh")

  dobMonth String?
  dobDay   Int?
  dobYear  Int?

  twitter  String?
  linkedin String?
  facebook String?
  github   String?
  website  String?

  slogan String?
  bio    String?

  twoFA       Boolean   @default(false)
  lastLoginAt DateTime?
  lastLoginIp String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}


// ==== part: Refund.prisma ====
enum RefundStatus {
  PENDING
  APPROVED
  PROCESSING
  SUCCEEDED
  FAILED
  CANCELLED
}

enum RefundReason {
  CUSTOMER_REQUEST
  DAMAGED
  WRONG_ITEM
  NOT_RECEIVED
  CANCELLED_ORDER
  DUPLICATE_PAYMENT
  OTHER
}

model Refund {
  id        String       @id @default(cuid())

  userId    String
  user      User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  // keep as plain ids (no relations)
  orderId           String?
  originalPaymentId String?
  refundPaymentId   String?  @unique

  status    RefundStatus @default(PENDING)
  reason    RefundReason @default(OTHER)

  amountCents Int
  currency  CurrencyCode @default(VND)

  reference String?
  notes     String?

  requestedAt DateTime @default(now())
  approvedAt  DateTime?
  processedAt DateTime?
  completedAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId, createdAt])
  @@index([orderId, createdAt])
  @@index([status, createdAt])
  @@index([reason, createdAt])
}

model RefundItem {
  id        String  @id @default(cuid())

  // keep as plain ids (no relations)
  refundId   String?
  orderItemId String?

  qty         Int     @default(1)
  amountCents Int     @default(0)
  notes       String?

  @@index([refundId])
  @@index([orderItemId])
}


// ==== part: Site.prisma ====
model Site {
  id        String   @id @default(cuid())
  domain    String   @unique
  name      String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  pages     Page[]
}


// ==== part: Storage.prisma ====
enum StorageProvider {
  LOCAL
  S3
  R2
}

enum StorageStatus {
  DISCONNECTED
  CONNECTED
  ERROR
}

enum ObjectVisibility {
  PUBLIC
  PRIVATE
}

enum StorageLogLevel {
  INFO
  WARN
  ERROR
}

model StorageIntegration {
  id                     String          @id @default(uuid())

  userId                 String          @unique
  user                   User            @relation(fields: [userId], references: [id], onDelete: Cascade)

  provider               StorageProvider @default(R2)
  status                 StorageStatus   @default(DISCONNECTED)

  // Common
  publicBaseUrl           String
  rootPrefix              String          @default("uploads/")
  privateByDefault        Boolean         @default(true)
  signedUrlEnabled        Boolean         @default(true)
  signedUrlTtlSeconds     Int             @default(900)

  maxUploadMb             Int             @default(50)
  allowedMime             String          @default("image/*,application/pdf")
  enableImageOptimization Boolean         @default(true)

  // Local
  localDir                String?

  // S3/R2
  region                  String?
  bucket                  String?
  endpointUrl             String?
  accessKeyIdEnc          String?
  secretAccessKeyEnc      String?

  // CDN
  cacheControl            String          @default("public,max-age=31536000,immutable")
  purgeEnabled            Boolean         @default(false)

  // Diagnostics
  lastTestedAt            DateTime?
  lastError               String?

  createdAt               DateTime        @default(now())
  updatedAt               DateTime        @updatedAt
}

model StorageBucket {
  id            String          @id @default(uuid())

  // keep as plain id (no relation)
  integrationId String?

  provider     StorageProvider
  name         String
  region       String?
  endpointUrl  String?
  isDefault    Boolean        @default(false)

  objectsCount Int            @default(0)
  sizeBytes    BigInt         @default(0)

  createdAt    DateTime       @default(now())
  updatedAt    DateTime       @updatedAt

  @@index([integrationId, provider])
  @@unique([integrationId, provider, name])
}

model StorageObject {
  id             String           @id @default(uuid())

  // keep as plain id (no relation)
  integrationId  String?

  provider       StorageProvider
  bucket         String
  key            String

  sizeBytes      BigInt
  mimeType       String
  visibility     ObjectVisibility @default(PRIVATE)

  etag           String?
  checksum       String?
  lastModifiedAt DateTime?

  deletedAt      DateTime?
  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @updatedAt

  @@unique([integrationId, provider, bucket, key])
  @@index([integrationId, key])
  @@index([integrationId, visibility])
  @@index([integrationId, updatedAt(sort: Desc)])
}

model StorageLog {
  id            String   @id @default(uuid())

  // keep as plain id (no relation)
  integrationId String?

  at            DateTime        @default(now())
  level         StorageLogLevel @default(INFO)
  action        String
  message       String
  meta          Json?

  @@index([integrationId, at(sort: Desc)])
  @@index([integrationId, level])
}


// ==== part: Webhook.prisma ====
// ===== ENUMS =====
enum WebhookDirection {
  inbound
  outbound
}

enum WebhookStatus {
  active
  paused
  error
}

enum WebhookAuthType {
  none
  hmac_sha256
  static_header
}

enum RetryStrategy {
  none
  fixed
  exponential
}

enum WebhookDeliveryStatus {
  success
  failed
  retrying
}

enum WebhookMethod {
  POST
  PUT
  PATCH
}

model Webhook {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  userId String // chỉ lưu id, không FK (no relation)

  name      String
  direction WebhookDirection
  status    WebhookStatus @default(active)

  eventKey  String

  endpointPath   String?
  destinationUrl String?
  method         WebhookMethod @default(POST)

  security    Json?
  mapping     Json?
  retryPolicy Json?

  lastTriggeredAt DateTime?
  success24h      Int @default(0)
  fail24h         Int @default(0)

  @@index([userId])
  @@index([userId, direction, status])
  @@index([userId, eventKey])
}

model WebhookDelivery {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())

  // keep as plain id (no relation)
  webhookId String?

  status WebhookDeliveryStatus @default(success)

  payload Json?
}


// ==== part: user.prisma ====
enum UserRole {
  USER
  ADMIN
}

enum AuditAction {
  ADMIN_LOGIN_SUCCESS
  ADMIN_LOGIN_FAIL
  ADMIN_LOGOUT
  PASSWORD_CHANGE
  TWOFA_ENABLED
  TWOFA_DISABLED
  TWOFA_CHALLENGE_FAIL
  SESSION_REVOKED
  SESSION_REVOKE_ALL
  ADMIN_SENSITIVE_ACTION
}

enum AuditResult {
  SUCCESS
  FAIL
}

enum SessionType {
  ADMIN
  USER
}

model User {
  id                String   @id @default(cuid())
  email             String   @unique
  emailVerifiedAt   DateTime?
  role              UserRole @default(USER)
  isActive          Boolean  @default(true)

  image             String?

  passwordHash      String
  passwordUpdatedAt DateTime @default(now())

  failedLoginCount  Int      @default(0)
  lockedUntil       DateTime?

  requireReauthAt   DateTime?

  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  sessions          Session[]
  twoFactor         TwoFactor?
  backupCodes       BackupCode[]
  auditLogs         AuditLog[]

  profile           Profile?

  // ✅ FRIEND RELATIONS
  friendRequestsSent     FriendRequest[] @relation("FriendReqFrom")
  friendRequestsReceived FriendRequest[] @relation("FriendReqTo")

  // ✅ BLOCK RELATIONS
  blocksSent     Block[] @relation("Blocker")
  blocksReceived Block[] @relation("Blocked")


  calendars      Calendar[]
  calendarEvents CalendarEvent[] @relation("UserCreatedEvents")

  folders FileFolder[]
  files   StoredFile[]

  images    ImageAsset[]
  imageFolders ImageFolder[]

    // Spending / finance
  transactions    Transaction[]
  spendCategories SpendCategory[]
  merchants       Merchant[]

  // Inventory / sales
  products        Product[]
  suppliers       Supplier[]
  inventoryReceipts InventoryReceipt[]

 customers Customer[]
  orders    Order[]


  @@index([role])
  @@index([lockedUntil])
}



model Session {
  id              String      @id @default(cuid())
  userId          String
  user            User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  type            SessionType @default(USER)
  tokenHash       String      @unique
  createdAt       DateTime    @default(now())
  expiresAt       DateTime
  lastSeenAt      DateTime    @default(now())
  ip              String?
  userAgent       String?
  country         String?
  revokedAt       DateTime?
  revokeReason    String?
  @@index([userId, type])
  @@index([expiresAt])
  @@index([revokedAt])
}

model TwoFactor {
  id            String   @id @default(cuid())
  userId        String   @unique
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  enabled       Boolean  @default(false)
  secretEnc     String?
  lastUsedAt    DateTime?
  enabledAt     DateTime?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
}

model BackupCode {
  id          String   @id @default(cuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  codeHash    String
  usedAt      DateTime?
  createdAt   DateTime @default(now())
  @@unique([userId, codeHash])
  @@index([userId, usedAt])
}

model LoginAttempt {
  id          String   @id @default(cuid())
  email       String?
  ip          String
  fingerprint String?
  success     Boolean  @default(false)
  createdAt   DateTime @default(now())
  @@index([ip, createdAt])
  @@index([email, createdAt])
  @@index([fingerprint, createdAt])
}

model AuditLog {
  id          String      @id @default(cuid())
  userId      String?
  user        User?       @relation(fields: [userId], references: [id], onDelete: SetNull)
  action      AuditAction
  result      AuditResult
  ip          String?
  userAgent   String?
  metaJson    Json?
  createdAt   DateTime    @default(now())
  @@index([userId, createdAt])
  @@index([action, createdAt])
}
