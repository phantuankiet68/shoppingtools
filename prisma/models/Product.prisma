enum ProductStatus {
  DRAFT
  ACTIVE
  ARCHIVED
}

model Product {
  id          String        @id @default(cuid())
  siteId      String        @map("site_id")

  name        String
  slug        String
  description String?

  status      ProductStatus @default(DRAFT)

  createdAt   DateTime      @default(now()) @map("created_at")
  updatedAt   DateTime      @updatedAt @map("updated_at")
  deletedAt   DateTime?     @map("deleted_at")

  // relations
  site        Site          @relation(fields: [siteId], references: [id], onDelete: Cascade)
  variants    ProductVariant[]
  optionValues ProductOptionValue[]
  images      ProductImage[]
  categoryMap ProductCategoryMap[]

  @@unique([siteId, slug])
  @@index([siteId])
  @@index([siteId, status])
  @@map("products")
}

model ProductVariant {
  id             String   @id @default(cuid())
  productId       String   @map("product_id")

  // "sku UNIQUE trong site" -> để enforce đúng, cần thêm siteId (denormalize) hoặc unique composite qua relation (Prisma không làm unique join)
  siteId          String   @map("site_id") // ✅ thêm để unique(sku, siteId) đúng yêu cầu
  sku             String

  price           Decimal  @db.Decimal(12, 2)
  compareAtPrice  Decimal? @db.Decimal(12, 2) @map("compare_at_price")

  stockQty        Int      @default(0) @map("stock_qty")
  barcode         String?
  weight          Decimal? @db.Decimal(12, 3)

  isDefault       Boolean  @default(false) @map("is_default")

  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")
  deletedAt       DateTime? @map("deleted_at")

  // relations
  product         Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  site            Site     @relation(fields: [siteId], references: [id], onDelete: Cascade)
  images          ProductImage[]

  @@index([productId])
  @@index([siteId])
  @@unique([siteId, sku]) // ✅ sku unique trong site
  @@map("product_variants")
}

model ProductOptionValue {
  id          String   @id @default(cuid())
  productId   String   @map("product_id")

  optionName  String   @map("option_name")  // vd: Color, Size
  optionValue String   @map("option_value") // vd: Red, XL
  createdAt   DateTime @default(now()) @map("created_at")

  product     Product  @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@index([productId])
  // tuỳ bạn: tránh trùng option y hệt trong 1 product
  @@unique([productId, optionName, optionValue])
  @@map("product_option_values")
}

model ProductImage {
  id        String   @id @default(cuid())
  productId String   @map("product_id")
  variantId String?  @map("variant_id")
  imageUrl  String   @map("image_url")
  sortOrder Int      @default(0) @map("sort_order")
  createdAt DateTime @default(now()) @map("created_at")
  product   Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  variant   ProductVariant? @relation(fields: [variantId], references: [id], onDelete: SetNull)
  @@index([productId])
  @@index([variantId])
  @@index([productId, sortOrder])
  @@map("product_images")
}

model ProductCategory {
  id        String   @id @default(cuid())
  siteId    String   @map("site_id")
  name      String
  slug      String
  parentId  String?  @map("parent_id")
  sortOrder Int      @default(0) @map("sort_order")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  site      Site     @relation(fields: [siteId], references: [id], onDelete: Cascade)
  parent    ProductCategory? @relation("CategoryTree", fields: [parentId], references: [id], onDelete: SetNull)
  children  ProductCategory[] @relation("CategoryTree")
  products  ProductCategoryMap[]
  @@unique([siteId, slug])
  @@index([siteId])
  @@index([parentId])
  @@index([siteId, sortOrder])
  @@map("product_categories")
}

model ProductCategoryMap {
  productId  String @map("product_id")
  categoryId String @map("category_id")
  product    Product         @relation(fields: [productId], references: [id], onDelete: Cascade)
  category   ProductCategory @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  @@id([productId, categoryId])
  @@index([categoryId])
  @@map("product_category_map")
}
