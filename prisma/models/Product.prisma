enum CurrencyCode {
  USD
  VND
}

enum PaymentMethod {
  CARD
  BANK
  CASH
  EWALLET
  COD
}

enum TxStatus {
  PENDING
  PAID
  REFUNDED
  CANCELLED
}

enum TxType {
  EXPENSE      // chi phí
  INCOME       // thu nhập (nếu sau này bạn muốn)
  ADJUSTMENT   // điều chỉnh
}

enum SpendCategoryType {
  INVENTORY
  SOFTWARE
  MARKETING
  OPS
  TRAVEL
  OFFICE
  OTHER
}

enum ReceiptStatus {
  PENDING
  RECEIVED
  CANCELLED
}

enum SalesChannel {
  SHOP
  MARKETPLACE
  WHOLESALE
}

enum SalesStatus {
  DELIVERING
  DELIVERED
  RETURNED
  CANCELLED
}

enum OrderStatus {
  PENDING
  CONFIRMED
  DELIVERING
  DELIVERED
  CANCELLED
  RETURNED
}

enum PaymentStatus {
  UNPAID
  PARTIAL
  PAID
  REFUNDED
  CANCELLED
}

enum FulfillmentStatus {
  UNFULFILLED
  PARTIAL
  FULFILLED
  CANCELLED
  RETURNED
}




model SpendCategory {
  id        String            @id @default(cuid())
  name      String            @unique
  type      SpendCategoryType @default(OTHER)
  icon      String?           // optional: "bi-cash-stack"...
  color     String?           // optional: "blue", "#0ea5e9"
  isActive  Boolean           @default(true)

  createdAt DateTime          @default(now())
  updatedAt DateTime          @updatedAt

  transactions Transaction[]

  @@index([type])
}

model Merchant {
  id        String   @id @default(cuid())
  name      String   @unique
  website   String?
  email     String?
  phone     String?
  address   String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  transactions Transaction[]
}

model Transaction {
  id            String        @id @default(cuid())
  userId        String
  user          User          @relation(fields: [userId], references: [id], onDelete: Cascade)


  type          TxType        @default(EXPENSE)
  status        TxStatus      @default(PAID)
  method        PaymentMethod @default(CARD)
  currency      CurrencyCode  @default(USD)

  title         String
  description   String?

  merchantId    String?
  merchant      Merchant?     @relation(fields: [merchantId], references: [id], onDelete: SetNull)

  categoryId    String?
  category      SpendCategory? @relation(fields: [categoryId], references: [id], onDelete: SetNull)

  subtotalCents Int           @default(0)
  taxCents      Int           @default(0)
  totalCents    Int           @default(0)

  occurredAt    DateTime
  reference     String?
  notes         String?

  inventoryReceiptId String? @unique

  lines        TransactionLine[]

  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@index([userId, occurredAt])
  @@index([status])
  @@index([categoryId])
  @@index([merchantId])

}


model TransactionLine {
  id            String      @id @default(cuid())
  transactionId String
  transaction   Transaction @relation(fields: [transactionId], references: [id], onDelete: Cascade)

  // optional: gắn vào product nếu là mua hàng hoá
  productId     String?
  product       Product?    @relation(fields: [productId], references: [id], onDelete: SetNull)

  title         String
  qty           Int         @default(1)
  unitPriceCents Int        @default(0)
  totalCents    Int         @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([transactionId])
  @@index([productId])
}


model ProductCategory {
  id        String @id @default(cuid())
  userId    String
  user      User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  siteId    String

  name      String
  slug      String
  isActive  Boolean @default(true)

  parentId  String?
  parent    ProductCategory? @relation("CategoryTree", fields: [parentId], references: [id], onDelete: SetNull)
  children  ProductCategory[] @relation("CategoryTree")

  sort      Int @default(0)

  icon      String?
  coverImage String?
  seoTitle  String?
  seoDesc   String? @db.Text

  products  Product[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, slug])
  @@unique([userId, name])
  @@index([userId])
  @@index([userId, parentId])
  @@index([userId, parentId, sort])
}



model Product {
  id        String @id @default(cuid())
  userId    String
  user      User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  name        String
  slug        String
  description String? @db.Text

  sku       String
  barcode   String?

  priceCents Int @default(0)
  costCents  Int @default(0)
  stock      Int @default(0)

  hasVariants       Boolean @default(false)
  displayPriceCents Int     @default(0)  // ví dụ: min variant price hoặc product price
  displayStock      Int     @default(0)  // ví dụ: sum variant stock hoặc product stock

  isActive   Boolean @default(true)

  categoryId String?
  category   ProductCategory? @relation(fields: [categoryId], references: [id], onDelete: SetNull)

  images     ProductImage[]
  attributes ProductAttribute[]
  variants   ProductVariant[]
  stockMovements StockMovement[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, sku])
  @@unique([userId, slug])
  @@unique([userId, barcode])
  @@index([userId])
  @@index([userId, name])
  @@index([userId, isActive])
  @@index([userId, hasVariants])
  @@index([userId, categoryId, isActive])
}



model Supplier {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  name      String
  email     String?
  phone     String?
  address   String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  receipts  InventoryReceipt[]

  @@unique([userId, name])
  @@index([userId])
}

model InventoryReceipt {
  id          String        @id @default(cuid())
  userId      String
  user        User          @relation(fields: [userId], references: [id], onDelete: Cascade)

  supplierId  String?
  supplier    Supplier?     @relation(fields: [supplierId], references: [id], onDelete: SetNull)

  // NEW: link to PO
  poId        String?
  po          PurchaseOrder? @relation(fields: [poId], references: [id], onDelete: SetNull)

  status      ReceiptStatus @default(PENDING)
  currency    CurrencyCode  @default(USD)

  receivedAt  DateTime?
  reference   String?

  subtotalCents Int @default(0)
  taxCents      Int @default(0)
  totalCents    Int @default(0)

  notes       String?

  items       InventoryReceiptItem[]
  transaction Transaction?

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([userId, createdAt])
  @@index([userId, receivedAt])
  @@index([status])
  @@index([supplierId])
  @@index([userId, supplierId])

  // NEW
  @@index([poId])
  @@index([userId, poId])
}


model InventoryReceiptItem {
  id        String @id @default(cuid())

  receiptId String
  receipt   InventoryReceipt @relation(fields: [receiptId], references: [id], onDelete: Cascade)

  // NEW: link to PO line (optional vì có thể nhận hàng không qua PO)
  poLineId  String?
  poLine    PurchaseOrderLine? @relation(fields: [poLineId], references: [id], onDelete: SetNull)

  productId String
  product   Product @relation(fields: [productId], references: [id], onDelete: Restrict)

  variantId String?
  variant   ProductVariant? @relation(fields: [variantId], references: [id], onDelete: Restrict)

  qty           Int
  unitCostCents Int
  totalCents    Int

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([receiptId])
  @@index([productId])
  @@index([variantId])
  @@index([productId, createdAt])
  @@index([variantId, createdAt])

  // NEW
  @@index([poLineId])
}


model ProductImage {
  id        String   @id @default(cuid())

  productId String
  product   Product  @relation(fields: [productId], references: [id], onDelete: Cascade)

  // URL ảnh (đã upload lên /uploads hoặc S3...)
  url       String

  // Tên file (optional)
  fileName  String?

  // sắp xếp ảnh trong gallery
  sort      Int      @default(0)

  // ảnh cover (optional nhưng rất hữu ích)
  isCover   Boolean  @default(false)

  createdAt DateTime @default(now())

  @@index([productId])
  @@index([productId, sort])
}


model ProductAttribute {
  id        String @id @default(cuid())

  productId String
  product   Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  key       String   // ví dụ: "Chất liệu"
  value     String   // ví dụ: "Cotton"
  sort      Int      @default(0)

  @@index([productId, sort])
}


model Order {
  id        String @id @default(cuid())

  userId    String
  user      User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // customer (optional)
  customerId String?
  customer   Customer? @relation(fields: [customerId], references: [id], onDelete: SetNull)

  // status (ops)
  status     OrderStatus @default(PENDING)

  // NEW: tách payment & fulfillment để UI/admin rõ ràng
  paymentStatus     PaymentStatus     @default(UNPAID)
  fulfillmentStatus FulfillmentStatus @default(UNFULFILLED)

  // channel / ref
  channel   SalesChannel @default(SHOP)
  currency  CurrencyCode @default(VND)

  // money
  subtotalCents Int @default(0)
  discountCents Int @default(0) // NEW
  shippingCents Int @default(0)
  taxCents      Int @default(0) // NEW
  totalCents    Int @default(0)

  // NEW: order code / external ref (marketplace)
  number     String?   // ORD-00001 (optional, nhưng nên có)
  reference  String?   // marketplace order id / note

  // NEW: shipping/customer snapshot (tránh đổi thông tin làm sai đơn cũ)
  customerNameSnapshot  String?
  customerPhoneSnapshot String?
  customerEmailSnapshot String?

  shipToName     String?
  shipToPhone    String?
  shipToAddress1 String?
  shipToAddress2 String?
  shipToCity     String?
  shipToState    String?
  shipToPostal   String?
  shipToCountry  String?

  // NEW: logistics
  carrier      String?
  trackingCode String?
  shippedAt    DateTime?
  deliveredAt  DateTime?
  cancelledAt  DateTime?
  returnedAt   DateTime?

  notes     String?
  tags      String? // optional: "vip, fragile"

  items     OrderItem[]

  payments  Payment[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId, createdAt])
  @@index([status])
  @@index([paymentStatus])
  @@index([fulfillmentStatus])
  @@index([userId, customerId])
  @@unique([userId, number])
}


model OrderItem {
  id        String @id @default(cuid())

  orderId   String
  order     Order   @relation(fields: [orderId], references: [id], onDelete: Cascade)

  productId String
  product   Product @relation(fields: [productId], references: [id], onDelete: Restrict)

  variantId String?
  variant   ProductVariant? @relation(fields: [variantId], references: [id], onDelete: SetNull)

  // qty ordered
  qty        Int

  // NEW: hỗ trợ partial flow
  qtyReserved Int @default(0)
  qtyShipped  Int @default(0)
  qtyReturned Int @default(0)

  // price snapshot
  unitPriceCents Int
  subtotalCents  Int @default(0) // unitPriceCents * qty (cache)
  discountCents  Int @default(0) // NEW
  taxCents       Int @default(0) // NEW
  totalCents     Int @default(0)

  // NEW: snapshot identity (để audit)
  skuSnapshot         String?
  productNameSnapshot String?
  variantNameSnapshot String?

  note String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([orderId])
  @@index([productId])
  @@index([variantId])
}



enum VariantStatus {
  ACTIVE
  INACTIVE
}

model ProductVariant {
  id        String   @id @default(cuid())

  productId String
  product   Product  @relation(fields: [productId], references: [id], onDelete: Cascade)

  name      String?  // ví dụ: "Đen"
  sku       String
  barcode   String?

  priceCents Int @default(0)
  costCents  Int @default(0)

  // inventory
  stock     Int @default(0)
  isActive  Boolean @default(true)

  option1   String? // "Color"
  value1    String? // "Black"
  option2   String?
  value2    String?

  images    ProductVariantImage[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([productId, sku])
  @@index([productId])
  @@index([productId, isActive])
}

model ProductVariantImage {
  id        String @id @default(cuid())

  variantId String
  variant   ProductVariant @relation(fields: [variantId], references: [id], onDelete: Cascade)

  url       String
  fileName  String?
  sort      Int     @default(0)
  isCover   Boolean @default(false)

  createdAt DateTime @default(now())

  @@index([variantId])
  @@index([variantId, sort])
}

enum StockMovementType {
  IN
  OUT
  ADJUST
  RETURN_IN
  VOID
}

enum StockMovementSource {
  RECEIPT
  ORDER
  MANUAL
}

model StockMovement {
  id        String @id @default(cuid())

  userId    String
  user      User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  productId String
  product   Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  variantId String?
  variant   ProductVariant? @relation(fields: [variantId], references: [id], onDelete: Cascade)

  type      StockMovementType
  source    StockMovementSource

  qtyDelta  Int
  occurredAt DateTime

  beforeStock Int?
  afterStock  Int?

  note      String?
  reference String?

  receiptItemId String?
  orderItemId   String?

  // NEW: chống tạo trùng khi user double click / retry
  idempotencyKey String?

  createdAt DateTime @default(now())

  @@index([userId, occurredAt])
  @@index([productId, occurredAt])
  @@index([variantId, occurredAt])
  @@index([orderItemId, occurredAt])

  @@unique([receiptItemId])
  // REMOVE: @@unique([orderItemId])
  @@unique([idempotencyKey])
}


enum POStatus {
  DRAFT
  APPROVED
  PARTIAL
  RECEIVED
  CANCELLED
}


model PurchaseOrder {
  id         String   @id @default(cuid())
  userId     String
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  number     String   // PO-00012
  status     POStatus @default(DRAFT)

  supplierId String?
  supplier   Supplier? @relation(fields: [supplierId], references: [id], onDelete: SetNull)

  currency   CurrencyCode @default(USD)
  expectedAt DateTime?
  notes      String?

  // totals cache (optional but recommended for fast UI)
  subtotalCents Int @default(0)
  taxCents      Int @default(0)
  totalCents    Int @default(0)

  lines     PurchaseOrderLine[]
  receipts  InventoryReceipt[]   // link ngược qua InventoryReceipt.poId

  approvedAt DateTime?
  cancelledAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, number])
  @@index([userId, createdAt])
  @@index([status])
  @@index([supplierId])
}

model PurchaseOrderLine {
  id        String @id @default(cuid())

  poId      String
  po        PurchaseOrder @relation(fields: [poId], references: [id], onDelete: Cascade)

  productId String
  product   Product @relation(fields: [productId], references: [id], onDelete: Restrict)

  variantId String?
  variant   ProductVariant? @relation(fields: [variantId], references: [id], onDelete: Restrict)

  // snapshots for audit/history
  skuSnapshot  String?
  nameSnapshot String?

  qtyOrdered   Int
  qtyReceived  Int @default(0)

  unitCostCents Int @default(0)
  totalCents    Int @default(0) // qtyOrdered * unitCostCents (cache)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([poId])
  @@index([productId])
  @@index([variantId])
}



