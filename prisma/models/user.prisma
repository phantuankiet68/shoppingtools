enum UserRole {
  USER
  ADMIN
}

enum AuditAction {
  ADMIN_LOGIN_SUCCESS
  ADMIN_LOGIN_FAIL
  ADMIN_LOGOUT
  PASSWORD_CHANGE
  TWOFA_ENABLED
  TWOFA_DISABLED
  TWOFA_CHALLENGE_FAIL
  SESSION_REVOKED
  SESSION_REVOKE_ALL
  ADMIN_SENSITIVE_ACTION
}

enum AuditResult {
  SUCCESS
  FAIL
}

enum SessionType {
  ADMIN
  USER
}

model User {
  id                String   @id @default(cuid())
  email             String   @unique
  emailVerifiedAt   DateTime?
  role              UserRole @default(USER)
  isActive          Boolean  @default(true)

  image             String?

  passwordHash      String
  passwordUpdatedAt DateTime @default(now())

  failedLoginCount  Int      @default(0)
  lockedUntil       DateTime?

  requireReauthAt   DateTime?

  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  sessions          Session[]
  twoFactor         TwoFactor?
  backupCodes       BackupCode[]
  auditLogs         AuditLog[]

  profile           Profile?

  // ✅ FRIEND RELATIONS
  friendRequestsSent     FriendRequest[] @relation("FriendReqFrom")
  friendRequestsReceived FriendRequest[] @relation("FriendReqTo")

  // ✅ BLOCK RELATIONS
  blocksSent     Block[] @relation("Blocker")
  blocksReceived Block[] @relation("Blocked")


  calendars      Calendar[]
  calendarEvents CalendarEvent[] @relation("UserCreatedEvents")

  folders FileFolder[]
  files   StoredFile[]

  images    ImageAsset[]
  imageFolders ImageFolder[]

    // Spending / finance
  transactions    Transaction[]
  spendCategories SpendCategory[]
  merchants       Merchant[]

  // Inventory / sales
  products        Product[]
  suppliers       Supplier[]
  inventoryReceipts InventoryReceipt[]

 customers Customer[]
  orders    Order[]


  @@index([role])
  @@index([lockedUntil])
}



model Session {
  id              String      @id @default(cuid())
  userId          String
  user            User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  type            SessionType @default(USER)
  tokenHash       String      @unique
  createdAt       DateTime    @default(now())
  expiresAt       DateTime
  lastSeenAt      DateTime    @default(now())
  ip              String?
  userAgent       String?
  country         String?
  revokedAt       DateTime?
  revokeReason    String?
  @@index([userId, type])
  @@index([expiresAt])
  @@index([revokedAt])
}

model TwoFactor {
  id            String   @id @default(cuid())
  userId        String   @unique
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  enabled       Boolean  @default(false)
  secretEnc     String?
  lastUsedAt    DateTime?
  enabledAt     DateTime?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
}

model BackupCode {
  id          String   @id @default(cuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  codeHash    String
  usedAt      DateTime?
  createdAt   DateTime @default(now())
  @@unique([userId, codeHash])
  @@index([userId, usedAt])
}

model LoginAttempt {
  id          String   @id @default(cuid())
  email       String?
  ip          String
  fingerprint String?
  success     Boolean  @default(false)
  createdAt   DateTime @default(now())
  @@index([ip, createdAt])
  @@index([email, createdAt])
  @@index([fingerprint, createdAt])
}

model AuditLog {
  id          String      @id @default(cuid())
  userId      String?
  user        User?       @relation(fields: [userId], references: [id], onDelete: SetNull)
  action      AuditAction
  result      AuditResult
  ip          String?
  userAgent   String?
  metaJson    Json?
  createdAt   DateTime    @default(now())
  @@index([userId, createdAt])
  @@index([action, createdAt])
}
